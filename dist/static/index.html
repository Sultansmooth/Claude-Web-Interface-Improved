<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/png" href="/claude-icon.png" />
    <link rel="shortcut icon" type="image/png" href="/claude-icon.png" />
    <link rel="apple-touch-icon" href="/claude-icon.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <title>Claude Code Web UI</title>
    <script>
      // Prevent flash of unstyled content by setting theme class early
      (function () {
        const storedTheme = localStorage.getItem("claude-code-webui-theme");
        let theme = null;
        try {
          theme = storedTheme ? JSON.parse(storedTheme) : null;
        } catch {
          // If parsing fails, fall back to null
          theme = null;
        }
        
        if (
          theme === "dark" ||
          (!theme && window.matchMedia("(prefers-color-scheme: dark)").matches)
        ) {
          document.documentElement.classList.add("dark");
        } else {
          document.documentElement.classList.remove("dark");
        }
      })();
    </script>
    <script>
      // Tab renaming - press F2 or use Tools panel
      // Priority: manual name > auto-detected project > default
      (function() {
        var MANUAL_KEY = 'claude-tab-name-' + window.location.pathname;
        var AUTO_KEY = 'claude-tab-autoname-' + window.location.pathname;
        var manualName = localStorage.getItem(MANUAL_KEY);
        var autoName = localStorage.getItem(AUTO_KEY);
        if (manualName) document.title = manualName;
        else if (autoName) document.title = autoName;

        // Set auto-title from project path (called by sidebar + cd detection)
        // Optional customLabel parameter uses the project's renamed label
        window._autoTitleFromPath = function(path, customLabel) {
          // Don't override manual name
          if (localStorage.getItem(MANUAL_KEY)) return;
          var name;
          if (customLabel) {
            name = customLabel;
          } else {
            var parts = path.replace(/\\/g, '/').replace(/\/$/, '').split('/');
            name = parts[parts.length - 1] || path;
          }
          document.title = name;
          localStorage.setItem(AUTO_KEY, name);
        };

        // Manual rename - overrides auto-title
        window._renameTab = function() {
          var name = prompt('Rename this tab (leave blank to use auto-detect):', document.title);
          if (name === null) return; // cancelled
          if (name.trim() === '') {
            // Clear manual override, revert to auto
            localStorage.removeItem(MANUAL_KEY);
            var auto = localStorage.getItem(AUTO_KEY);
            document.title = auto || 'Claude Code Web UI';
          } else {
            document.title = name;
            localStorage.setItem(MANUAL_KEY, name);
          }
        };
        document.addEventListener('keydown', function(e) {
          if (e.key === 'F2') { e.preventDefault(); window._renameTab(); }
        });
      })();
    </script>
    <script type="module" crossorigin src="/assets/index-4YPRjJF7.js"></script>
    <link rel="stylesheet" crossorigin href="/assets/index-Cy5ryi6l.css">
  </head>
  <body>
    <div id="root"></div>
    <script>
      // Sidebar with Projects + Docs tabs
      (function() {
        var STORAGE_KEY = 'claude-webui-project-dirs';
        var COLLAPSED_KEY = 'claude-webui-sidebar-collapsed';
        var TAB_KEY = 'claude-webui-sidebar-tab';
        var ACTIVE_DIR_KEY = 'claude-webui-active-dir';

        function getItems() {
          try {
            var raw = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            if (raw.length && typeof raw[0] === 'string') {
              var migrated = raw.map(function(s) { return { type: 'dir', path: s }; });
              saveItems(migrated);
              return migrated;
            }
            return raw;
          } catch { return []; }
        }
        function saveItems(items) { localStorage.setItem(STORAGE_KEY, JSON.stringify(items)); }
        function isCollapsed() { return localStorage.getItem(COLLAPSED_KEY) === '1'; }
        function setCollapsed(v) { localStorage.setItem(COLLAPSED_KEY, v ? '1' : '0'); }
        function getTab() { return localStorage.getItem(TAB_KEY) || 'projects'; }
        function setTab(t) { localStorage.setItem(TAB_KEY, t); }
        function getActiveDir() { return localStorage.getItem(ACTIVE_DIR_KEY) || ''; }
        function setActiveDir(d) { localStorage.setItem(ACTIVE_DIR_KEY, d); }

        function isDark() { return document.documentElement.classList.contains('dark'); }

        function sendToChat(text) {
          var ta = document.querySelector('textarea[placeholder="Type message..."]') ||
                   document.querySelector('textarea[placeholder="Processing..."]');
          if (!ta) return;
          var nativeSetter = Object.getOwnPropertyDescriptor(HTMLTextAreaElement.prototype, 'value').set;
          nativeSetter.call(ta, text);
          ta.dispatchEvent(new Event('input', { bubbles: true }));
          ta.focus();
          setTimeout(function() {
            var sendBtn = ta.closest('form') && ta.closest('form').querySelector('button[type="submit"]');
            if (sendBtn && !sendBtn.disabled) sendBtn.click();
          }, 50);
        }

        function showToast(msg) {
          var t = document.createElement('div');
          t.textContent = msg;
          t.style.cssText = 'position:fixed;bottom:20px;left:50%;transform:translateX(-50%);padding:8px 16px;border-radius:8px;font-size:13px;z-index:100000;transition:opacity 0.3s;pointer-events:none;' +
            (isDark() ? 'background:#334155;color:#e2e8f0;' : 'background:#1e293b;color:#f1f5f9;');
          document.body.appendChild(t);
          setTimeout(function() { t.style.opacity = '0'; }, 1500);
          setTimeout(function() { t.remove(); }, 1800);
        }

        // Doc viewer modal
        function showDocViewer(doc) {
          var existing = document.getElementById('doc-viewer-modal');
          if (existing) existing.remove();
          var dark = isDark();

          var overlay = document.createElement('div');
          overlay.id = 'doc-viewer-modal';
          overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);z-index:200000;display:flex;align-items:center;justify-content:center;';
          overlay.onclick = function(e) { if (e.target === overlay) overlay.remove(); };

          var modal = document.createElement('div');
          modal.style.cssText = 'width:90%;max-width:700px;max-height:80vh;display:flex;flex-direction:column;border-radius:12px;overflow:hidden;box-shadow:0 8px 32px rgba(0,0,0,0.3);' +
            (dark ? 'background:#1e293b;color:#e2e8f0;border:1px solid #334155;' : 'background:#fff;color:#1e293b;border:1px solid #e2e8f0;');

          var header = document.createElement('div');
          header.style.cssText = 'padding:12px 16px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid ' + (dark ? '#334155' : '#e2e8f0') + ';';
          var titleEl = document.createElement('span');
          titleEl.style.cssText = 'font-weight:600;font-size:14px;';
          titleEl.textContent = doc.name;
          header.appendChild(titleEl);

          var closeBtn = document.createElement('button');
          closeBtn.innerHTML = '&times;';
          closeBtn.style.cssText = 'border:none;background:none;cursor:pointer;font-size:20px;color:' + (dark ? '#94a3b8' : '#64748b') + ';';
          closeBtn.onclick = function() { overlay.remove(); };
          header.appendChild(closeBtn);
          modal.appendChild(header);

          var content = document.createElement('div');
          content.style.cssText = 'flex:1;overflow-y:auto;padding:16px;font-size:13px;line-height:1.6;white-space:pre-wrap;font-family:ui-monospace,monospace;' +
            (dark ? 'color:#cbd5e1;' : 'color:#334155;');
          content.textContent = 'Loading...';
          modal.appendChild(content);

          overlay.appendChild(modal);
          document.body.appendChild(overlay);

          // Fetch doc content
          fetch('/api/docs/read?path=' + encodeURIComponent(doc.path))
            .then(function(r) { return r.json(); })
            .then(function(data) {
              if (data.error) content.textContent = 'Error: ' + data.error;
              else content.textContent = data.content;
            })
            .catch(function() { content.textContent = 'Failed to load file.'; });
        }

        function render() {
          var existing = document.getElementById('proj-sidebar');
          if (existing) existing.remove();
          var toggleExisting = document.getElementById('proj-sidebar-toggle');
          if (toggleExisting) toggleExisting.remove();

          var dark = isDark();
          var collapsed = isCollapsed();
          var activeTab = getTab();

          // Toggle button
          var toggleBtn = document.createElement('button');
          toggleBtn.id = 'proj-sidebar-toggle';
          toggleBtn.innerHTML = collapsed ? '&#x1F4C1;' : '&#x2715;';
          toggleBtn.title = collapsed ? 'Open sidebar' : 'Close sidebar';
          toggleBtn.style.cssText = 'position:fixed;top:8px;right:' + (collapsed ? '8px' : '228px') + ';z-index:100001;border:1px solid ' + (dark ? 'rgba(148,163,184,0.3)' : 'rgba(128,128,128,0.3)') + ';border-radius:6px;cursor:pointer;font-size:14px;padding:4px 8px;opacity:0.6;transition:opacity 0.2s,right 0.2s;background:' + (dark ? '#1e293b' : '#fff') + ';color:' + (dark ? '#e2e8f0' : '#334155') + ';';
          toggleBtn.onmouseenter = function() { toggleBtn.style.opacity = '1'; };
          toggleBtn.onmouseleave = function() { toggleBtn.style.opacity = '0.6'; };
          toggleBtn.onclick = function() { setCollapsed(!collapsed); render(); };
          document.body.appendChild(toggleBtn);

          if (collapsed) return;

          // Sidebar panel
          var panel = document.createElement('div');
          panel.id = 'proj-sidebar';
          panel.style.cssText = 'position:fixed;top:0;right:0;width:220px;height:100vh;z-index:100000;display:flex;flex-direction:column;border-left:1px solid ' + (dark ? '#334155' : '#e2e8f0') + ';font-family:ui-sans-serif,system-ui,sans-serif;font-size:13px;' +
            (dark ? 'background:#0f172a;color:#e2e8f0;' : 'background:#f8fafc;color:#1e293b;');

          // Tab bar
          var tabBar = document.createElement('div');
          tabBar.style.cssText = 'display:flex;border-bottom:1px solid ' + (dark ? '#334155' : '#e2e8f0') + ';';

          function makeTab(label, key) {
            var tab = document.createElement('button');
            tab.textContent = label;
            var isActive = activeTab === key;
            tab.style.cssText = 'flex:1;padding:10px 0;border:none;cursor:pointer;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:0.05em;transition:background 0.15s;' +
              (isActive
                ? (dark ? 'background:#0f172a;color:#e2e8f0;border-bottom:2px solid #3b82f6;' : 'background:#f8fafc;color:#1e293b;border-bottom:2px solid #3b82f6;')
                : (dark ? 'background:#1e293b;color:#64748b;border-bottom:2px solid transparent;' : 'background:#e2e8f0;color:#94a3b8;border-bottom:2px solid transparent;'));
            tab.onmouseenter = function() { if (!isActive) tab.style.color = dark ? '#94a3b8' : '#64748b'; };
            tab.onmouseleave = function() { if (!isActive) tab.style.color = dark ? '#64748b' : '#94a3b8'; };
            tab.onclick = function() { setTab(key); render(); };
            return tab;
          }
          tabBar.appendChild(makeTab('Projects', 'projects'));
          tabBar.appendChild(makeTab('Docs', 'docs'));
          panel.appendChild(tabBar);

          if (activeTab === 'projects') {
            renderProjectsTab(panel, dark);
          } else {
            renderDocsTab(panel, dark);
          }

          document.body.appendChild(panel);
        }

        function renderProjectsTab(panel, dark) {
          // Header with separator button
          var header = document.createElement('div');
          header.style.cssText = 'padding:8px 12px 6px;display:flex;justify-content:flex-end;';
          var sepBtn = document.createElement('button');
          sepBtn.textContent = '\u2500';
          sepBtn.title = 'Add separator';
          sepBtn.style.cssText = 'border:none;background:none;cursor:pointer;font-size:16px;font-weight:600;padding:0 4px;color:' + (dark ? '#94a3b8' : '#64748b') + ';';
          sepBtn.onclick = function() {
            var items = getItems();
            items.push({ type: 'sep' });
            saveItems(items);
            render();
          };
          header.appendChild(sepBtn);
          panel.appendChild(header);

          // Add form
          var form = document.createElement('div');
          form.style.cssText = 'padding:0 8px 8px;display:flex;gap:4px;';
          var input = document.createElement('input');
          input.type = 'text';
          input.placeholder = 'C:\\path\\to\\project';
          input.style.cssText = 'flex:1;min-width:0;padding:5px 8px;border-radius:6px;font-size:12px;border:1px solid ' + (dark ? '#334155' : '#cbd5e1') + ';outline:none;' +
            (dark ? 'background:#1e293b;color:#e2e8f0;' : 'background:#fff;color:#1e293b;');
          input.onfocus = function() { input.style.borderColor = '#3b82f6'; };
          input.onblur = function() { input.style.borderColor = dark ? '#334155' : '#cbd5e1'; };
          var addBtn = document.createElement('button');
          addBtn.textContent = '+';
          addBtn.title = 'Add directory';
          addBtn.style.cssText = 'padding:4px 10px;border-radius:6px;cursor:pointer;font-size:14px;font-weight:600;border:none;' +
            (dark ? 'background:#1d4ed8;color:#fff;' : 'background:#3b82f6;color:#fff;');
          addBtn.onmouseenter = function() { addBtn.style.opacity = '0.85'; };
          addBtn.onmouseleave = function() { addBtn.style.opacity = '1'; };

          function addDir() {
            var val = input.value.trim();
            if (!val) return;
            var items = getItems();
            var exists = items.some(function(it) { return it.type === 'dir' && it.path === val; });
            if (!exists) {
              items.push({ type: 'dir', path: val });
              saveItems(items);
            }
            input.value = '';
            render();
          }
          addBtn.onclick = addDir;
          input.onkeydown = function(e) { if (e.key === 'Enter') addDir(); };
          form.appendChild(input);
          form.appendChild(addBtn);
          panel.appendChild(form);

          var topDivider = document.createElement('div');
          topDivider.style.cssText = 'height:1px;margin:0 8px;' + (dark ? 'background:#1e293b;' : 'background:#e2e8f0;');
          panel.appendChild(topDivider);

          // Rename helper
          function doRename(idx, currentLabel, folderName) {
            var newName = prompt('Rename project:\n(leave blank to reset to folder name: ' + folderName + ')', currentLabel);
            if (newName === null) return; // cancelled
            var its = getItems();
            if (newName.trim() === '' || newName.trim() === folderName) {
              delete its[idx].label;
            } else {
              its[idx].label = newName.trim();
            }
            saveItems(its);
            // Update tab title if this is the active project
            if (its[idx].path === getActiveDir() && window._autoTitleFromPath) {
              window._autoTitleFromPath(its[idx].path, its[idx].label);
            }
            render();
          }

          // Item list
          var dragIdx = null;
          var list = document.createElement('div');
          list.style.cssText = 'flex:1;overflow-y:auto;padding:4px 0;';

          var items = getItems();
          var activeDir = getActiveDir();
          if (items.length === 0) {
            var empty = document.createElement('div');
            empty.style.cssText = 'padding:16px 12px;text-align:center;font-size:12px;color:' + (dark ? '#475569' : '#94a3b8') + ';';
            empty.textContent = 'No saved directories';
            list.appendChild(empty);
          } else {
            items.forEach(function(item, idx) {
              var row = document.createElement('div');
              row.draggable = true;
              row.dataset.idx = idx;

              if (item.type === 'sep') {
                row.style.cssText = 'display:flex;align-items:center;padding:4px 8px;margin:1px 4px;gap:4px;transition:opacity 0.15s;';
                var handle = document.createElement('span');
                handle.textContent = '\u2261';
                handle.style.cssText = 'cursor:grab;font-size:12px;padding:0 2px;opacity:0.3;color:' + (dark ? '#94a3b8' : '#64748b') + ';flex-shrink:0;user-select:none;';
                handle.onmouseenter = function() { handle.style.opacity = '0.7'; };
                handle.onmouseleave = function() { handle.style.opacity = '0.3'; };
                row.appendChild(handle);
                var line = document.createElement('div');
                line.style.cssText = 'flex:1;height:1px;' + (dark ? 'background:#334155;' : 'background:#cbd5e1;');
                row.appendChild(line);
                var delBtn = document.createElement('button');
                delBtn.innerHTML = '&times;';
                delBtn.title = 'Remove separator';
                delBtn.style.cssText = 'border:none;background:none;cursor:pointer;font-size:14px;padding:0 2px;opacity:0.2;transition:opacity 0.15s;flex-shrink:0;color:' + (dark ? '#94a3b8' : '#64748b') + ';';
                delBtn.onmouseenter = function() { delBtn.style.opacity = '1'; delBtn.style.color = dark ? '#f87171' : '#ef4444'; };
                delBtn.onmouseleave = function() { delBtn.style.opacity = '0.2'; delBtn.style.color = dark ? '#94a3b8' : '#64748b'; };
                delBtn.onclick = function(e) {
                  e.stopPropagation();
                  var its = getItems();
                  its.splice(idx, 1);
                  saveItems(its);
                  render();
                };
                row.appendChild(delBtn);
              } else {
                var isActive = item.path === activeDir;
                row.style.cssText = 'display:flex;align-items:center;padding:6px 8px;margin:1px 4px;border-radius:6px;cursor:pointer;transition:background 0.15s,opacity 0.15s;gap:4px;' +
                  (isActive ? (dark ? 'background:#1e293b;border-left:2px solid #3b82f6;' : 'background:#e2e8f0;border-left:2px solid #3b82f6;') : '');
                row.onmouseenter = function() { row.style.background = dark ? '#1e293b' : '#e2e8f0'; };
                row.onmouseleave = function() { if (!isActive) row.style.background = 'transparent'; else row.style.background = dark ? '#1e293b' : '#e2e8f0'; };

                var handle = document.createElement('span');
                handle.textContent = '\u2261';
                handle.style.cssText = 'cursor:grab;font-size:12px;padding:0 2px;opacity:0.3;color:' + (dark ? '#94a3b8' : '#64748b') + ';flex-shrink:0;user-select:none;';
                handle.onmouseenter = function() { handle.style.opacity = '0.7'; };
                handle.onmouseleave = function() { handle.style.opacity = '0.3'; };
                row.appendChild(handle);

                var parts = item.path.replace(/\\/g, '/').replace(/\/$/, '').split('/');
                var folderName = parts[parts.length - 1] || item.path;
                var label = item.label || folderName;

                var nameSpan = document.createElement('span');
                nameSpan.style.cssText = 'flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-size:13px;font-weight:500;';
                nameSpan.textContent = label;
                nameSpan.title = item.path + (item.label ? '\n(' + folderName + ')' : '') + '\nClick to paste: cd ' + item.path + '\nDouble-click to rename';
                row.appendChild(nameSpan);

                // Rename button
                var renameBtn = document.createElement('button');
                renameBtn.textContent = '\u270F';
                renameBtn.title = 'Rename';
                renameBtn.style.cssText = 'border:none;background:none;cursor:pointer;font-size:11px;padding:0 2px;opacity:0.2;transition:opacity 0.15s;flex-shrink:0;color:' + (dark ? '#94a3b8' : '#64748b') + ';';
                renameBtn.onmouseenter = function() { renameBtn.style.opacity = '0.8'; renameBtn.style.color = dark ? '#60a5fa' : '#3b82f6'; };
                renameBtn.onmouseleave = function() { renameBtn.style.opacity = '0.2'; renameBtn.style.color = dark ? '#94a3b8' : '#64748b'; };
                renameBtn.onclick = function(e) {
                  e.stopPropagation();
                  doRename(idx, label, folderName);
                };
                row.appendChild(renameBtn);

                var delBtn = document.createElement('button');
                delBtn.innerHTML = '&times;';
                delBtn.title = 'Remove';
                delBtn.style.cssText = 'border:none;background:none;cursor:pointer;font-size:16px;line-height:1;padding:0 2px;opacity:0.3;transition:opacity 0.15s;flex-shrink:0;color:' + (dark ? '#94a3b8' : '#64748b') + ';';
                delBtn.onmouseenter = function() { delBtn.style.opacity = '1'; delBtn.style.color = dark ? '#f87171' : '#ef4444'; };
                delBtn.onmouseleave = function() { delBtn.style.opacity = '0.3'; delBtn.style.color = dark ? '#94a3b8' : '#64748b'; };
                delBtn.onclick = function(e) {
                  e.stopPropagation();
                  var its = getItems();
                  its.splice(idx, 1);
                  saveItems(its);
                  render();
                };
                row.appendChild(delBtn);

                // Double-click nameSpan to rename
                nameSpan.ondblclick = function(e) {
                  e.stopPropagation();
                  doRename(idx, label, folderName);
                };

                row.onclick = function(e) {
                  if (e.target === delBtn || e.target === renameBtn) return;
                  sendToChat('cd ' + item.path);
                  setActiveDir(item.path);
                  if (window._autoTitleFromPath) window._autoTitleFromPath(item.path, item.label);
                  render();
                };
              }

              // Drag-and-drop reordering
              row.ondragstart = function(e) {
                dragIdx = idx;
                e.dataTransfer.effectAllowed = 'move';
                row.style.opacity = '0.4';
              };
              row.ondragend = function() {
                row.style.opacity = '1';
                dragIdx = null;
                list.querySelectorAll('[data-idx]').forEach(function(r) {
                  r.style.borderTop = 'none';
                  r.style.borderBottom = 'none';
                });
              };
              row.ondragover = function(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                var targetIdx = parseInt(row.dataset.idx);
                list.querySelectorAll('[data-idx]').forEach(function(r) {
                  r.style.borderTop = 'none';
                  r.style.borderBottom = 'none';
                });
                if (dragIdx !== null && targetIdx !== dragIdx) {
                  if (targetIdx < dragIdx) row.style.borderTop = '2px solid #3b82f6';
                  else row.style.borderBottom = '2px solid #3b82f6';
                }
              };
              row.ondrop = function(e) {
                e.preventDefault();
                var targetIdx = parseInt(row.dataset.idx);
                if (dragIdx !== null && dragIdx !== targetIdx) {
                  var its = getItems();
                  var moved = its.splice(dragIdx, 1)[0];
                  its.splice(targetIdx, 0, moved);
                  saveItems(its);
                  render();
                }
              };

              list.appendChild(row);
            });
          }
          panel.appendChild(list);

          var footer = document.createElement('div');
          footer.style.cssText = 'padding:8px 12px;font-size:10px;text-align:center;color:' + (dark ? '#475569' : '#94a3b8') + ';border-top:1px solid ' + (dark ? '#1e293b' : '#e2e8f0') + ';';
          footer.textContent = 'Click \u2192 cd | Dbl-click \u2192 rename';
          panel.appendChild(footer);
        }

        function renderDocsTab(panel, dark) {
          var activeDir = getActiveDir();

          if (!activeDir) {
            var hint = document.createElement('div');
            hint.style.cssText = 'padding:24px 16px;text-align:center;font-size:12px;color:' + (dark ? '#475569' : '#94a3b8') + ';';
            hint.textContent = 'Click a project in the Projects tab first to scan for docs.';
            panel.appendChild(hint);
            return;
          }

          // Active dir label (use custom name if set)
          var dirLabel = document.createElement('div');
          dirLabel.style.cssText = 'padding:10px 12px 6px;font-size:11px;color:' + (dark ? '#64748b' : '#94a3b8') + ';';
          var dirParts = activeDir.replace(/\\/g, '/').replace(/\/$/, '').split('/');
          var activeDirName = dirParts[dirParts.length - 1] || activeDir;
          var activeDirItem = getItems().find(function(it) { return it.type === 'dir' && it.path === activeDir; });
          dirLabel.textContent = (activeDirItem && activeDirItem.label) || activeDirName;
          panel.appendChild(dirLabel);

          var divider = document.createElement('div');
          divider.style.cssText = 'height:1px;margin:0 8px;' + (dark ? 'background:#1e293b;' : 'background:#e2e8f0;');
          panel.appendChild(divider);

          // Search input
          var searchWrap = document.createElement('div');
          searchWrap.style.cssText = 'padding:6px 8px;';
          var searchInput = document.createElement('input');
          searchInput.type = 'text';
          searchInput.placeholder = 'Search docs...';
          searchInput.style.cssText = 'width:100%;box-sizing:border-box;padding:5px 8px;border-radius:6px;font-size:11px;border:1px solid ' + (dark ? '#334155' : '#cbd5e1') + ';outline:none;' +
            (dark ? 'background:#1e293b;color:#e2e8f0;' : 'background:#fff;color:#1e293b;');
          searchInput.onfocus = function() { searchInput.style.borderColor = '#3b82f6'; };
          searchInput.onblur = function() { searchInput.style.borderColor = dark ? '#334155' : '#cbd5e1'; };
          searchWrap.appendChild(searchInput);
          panel.appendChild(searchWrap);

          // Doc list container
          var list = document.createElement('div');
          list.style.cssText = 'flex:1;overflow-y:auto;padding:4px 0;';

          var loading = document.createElement('div');
          loading.style.cssText = 'padding:16px 12px;text-align:center;font-size:12px;color:' + (dark ? '#475569' : '#94a3b8') + ';';
          loading.textContent = 'Scanning...';
          list.appendChild(loading);
          panel.appendChild(list);

          // Render filtered doc list
          var allDocs = null;
          function renderDocList(filter) {
            list.innerHTML = '';
            if (!allDocs || allDocs.length === 0) {
              var empty = document.createElement('div');
              empty.style.cssText = 'padding:16px 12px;text-align:center;font-size:12px;color:' + (dark ? '#475569' : '#94a3b8') + ';';
              empty.textContent = 'No docs found';
              list.appendChild(empty);
              return;
            }
            var filtered = allDocs;
            if (filter) {
              var q = filter.toLowerCase();
              filtered = allDocs.filter(function(doc) {
                return doc.name.toLowerCase().indexOf(q) !== -1 ||
                       doc.folder.toLowerCase().indexOf(q) !== -1 ||
                       doc.path.toLowerCase().indexOf(q) !== -1;
              });
            }
            if (filtered.length === 0) {
              var noMatch = document.createElement('div');
              noMatch.style.cssText = 'padding:16px 12px;text-align:center;font-size:12px;color:' + (dark ? '#475569' : '#94a3b8') + ';';
              noMatch.textContent = 'No matches';
              list.appendChild(noMatch);
              return;
            }
            var groups = {};
            filtered.forEach(function(doc) {
              if (!groups[doc.folder]) groups[doc.folder] = [];
              groups[doc.folder].push(doc);
            });
            Object.keys(groups).forEach(function(folder) {
              var folderHeader = document.createElement('div');
              folderHeader.style.cssText = 'padding:6px 12px 2px;font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:0.05em;color:' + (dark ? '#64748b' : '#94a3b8') + ';';
              folderHeader.textContent = folder === 'root' ? 'Root' : folder + '/';
              list.appendChild(folderHeader);
              groups[folder].forEach(function(doc) {
                var row = document.createElement('div');
                row.style.cssText = 'display:flex;align-items:center;padding:5px 12px;margin:1px 4px;border-radius:6px;cursor:pointer;transition:background 0.15s;gap:6px;';
                row.onmouseenter = function() { row.style.background = dark ? '#1e293b' : '#e2e8f0'; };
                row.onmouseleave = function() { row.style.background = 'transparent'; };
                var icon = document.createElement('span');
                var ext = doc.name.split('.').pop().toLowerCase();
                icon.textContent = ext === 'md' ? '\uD83D\uDCDD' : ext === 'pdf' ? '\uD83D\uDCC4' : '\uD83D\uDCC3';
                icon.style.cssText = 'font-size:12px;flex-shrink:0;';
                row.appendChild(icon);
                var nameEl = document.createElement('span');
                nameEl.style.cssText = 'flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-size:12px;font-weight:500;';
                nameEl.textContent = doc.name;
                nameEl.title = doc.path;
                row.appendChild(nameEl);
                row.onclick = function() { showDocViewer(doc); };
                list.appendChild(row);
              });
            });
          }

          searchInput.oninput = function() { if (allDocs) renderDocList(searchInput.value.trim()); };

          // Fetch docs
          fetch('/api/docs?dir=' + encodeURIComponent(activeDir))
            .then(function(r) { return r.json(); })
            .then(function(docs) {
              allDocs = docs || [];
              renderDocList(searchInput.value.trim());
            })
            .catch(function() {
              list.innerHTML = '';
              var err = document.createElement('div');
              err.style.cssText = 'padding:16px 12px;text-align:center;font-size:12px;color:' + (dark ? '#f87171' : '#ef4444') + ';';
              err.textContent = 'Failed to scan directory';
              list.appendChild(err);
            });

          // Refresh button at bottom
          var footer = document.createElement('div');
          footer.style.cssText = 'padding:8px 12px;text-align:center;border-top:1px solid ' + (dark ? '#1e293b' : '#e2e8f0') + ';';
          var refreshBtn = document.createElement('button');
          refreshBtn.textContent = 'Refresh';
          refreshBtn.style.cssText = 'border:none;background:none;cursor:pointer;font-size:10px;color:' + (dark ? '#3b82f6' : '#2563eb') + ';';
          refreshBtn.onclick = function() { render(); };
          footer.appendChild(refreshBtn);
          panel.appendChild(footer);
        }

        // Watch for dark mode changes
        var observer = new MutationObserver(function(mutations) {
          mutations.forEach(function(m) {
            if (m.attributeName === 'class') render();
          });
        });

        window.addEventListener('load', function() {
          render();
          observer.observe(document.documentElement, { attributes: true });
          // On load, sync tab title with active project's custom label
          var activeDir = getActiveDir();
          if (activeDir && window._autoTitleFromPath) {
            var items = getItems();
            var activeItem = items.find(function(it) { return it.type === 'dir' && it.path === activeDir; });
            if (activeItem) window._autoTitleFromPath(activeDir, activeItem.label);
          }
        });
      })();
    </script>
    <script>
      // Session title - editable name below the session header
      (function() {
        var TITLES_KEY = 'claude-webui-session-titles';

        function getTitles() {
          try { return JSON.parse(localStorage.getItem(TITLES_KEY)) || {}; }
          catch { return {}; }
        }
        function saveTitle(sessionId, title) {
          var t = getTitles();
          if (title) t[sessionId] = title; else delete t[sessionId];
          localStorage.setItem(TITLES_KEY, JSON.stringify(t));
        }

        function getSessionId() {
          // Find the "Session: xxxxxxxx..." span in the header
          var spans = document.querySelectorAll('span');
          for (var i = 0; i < spans.length; i++) {
            var text = spans[i].textContent || '';
            var match = text.match(/Session:\s*([a-f0-9]{8})/);
            if (match) return match[1];
          }
          return null;
        }

        function isDark() { return document.documentElement.classList.contains('dark'); }

        function injectTitle() {
          if (document.getElementById('session-title-row')) return;

          // Get session ID: from React header span OR from SDK stream
          var sessionId = getSessionId();
          if (!sessionId && window.__currentFullSessionId) {
            sessionId = window.__currentFullSessionId.substring(0, 8);
          }
          if (!sessionId) return;

          // Try to find React's session span to inject next to it (original tab)
          var spans = document.querySelectorAll('span');
          var sessionSpan = null;
          for (var i = 0; i < spans.length; i++) {
            if ((spans[i].textContent || '').match(/Session:\s*[a-f0-9]{8}/)) {
              sessionSpan = spans[i];
              break;
            }
          }
          var headerRow = sessionSpan ? sessionSpan.closest('div') : null;

          // Fallback for forked tabs: find the sidebar/header area with project path
          if (!headerRow) {
            // Look for the flex-shrink-0 sidebar that contains project info
            var sidePanels = document.querySelectorAll('div.flex-shrink-0, div[class*="shrink"]');
            for (var sp = 0; sp < sidePanels.length; sp++) {
              var spText = sidePanels[sp].textContent || '';
              if (spText.indexOf('Conversation') !== -1 || spText.indexOf('C:/') !== -1 || spText.indexOf('C:\\') !== -1) {
                headerRow = sidePanels[sp];
                break;
              }
            }
            // Last resort: find any container with the project path
            if (!headerRow) {
              var allDivs = document.querySelectorAll('div');
              for (var d = 0; d < allDivs.length; d++) {
                var kids = allDivs[d].children;
                if (kids.length >= 1 && kids.length <= 8) {
                  for (var k = 0; k < kids.length; k++) {
                    var kidText = (kids[k].textContent || '').trim();
                    if (kidText.match(/^C:[/\\]/) && kidText.length < 80) {
                      headerRow = allDivs[d];
                      break;
                    }
                  }
                }
                if (headerRow) break;
              }
            }
          }
          if (!headerRow) return;

          var dark = isDark();
          var titles = getTitles();
          var currentTitle = titles[sessionId] || '';

          var row = document.createElement('div');
          row.id = 'session-title-row';
          row.style.cssText = 'display:flex;align-items:center;gap:6px;margin-top:4px;';

          var input = document.createElement('input');
          input.type = 'text';
          input.value = currentTitle;
          input.placeholder = 'Name this session...';
          input.style.cssText = 'padding:2px 8px;border-radius:5px;font-size:12px;font-weight:500;border:1px solid transparent;outline:none;min-width:120px;max-width:280px;width:' + Math.max(120, (currentTitle.length || 18) * 7.5) + 'px;transition:border-color 0.15s,background 0.15s;' +
            (dark
              ? 'background:transparent;color:#94a3b8;'
              : 'background:transparent;color:#64748b;');

          input.onfocus = function() {
            input.style.borderColor = dark ? '#3b82f6' : '#3b82f6';
            input.style.background = dark ? '#1e293b' : '#fff';
          };
          input.onblur = function() {
            input.style.borderColor = 'transparent';
            input.style.background = 'transparent';
            var val = input.value.trim();
            saveTitle(sessionId, val);
            input.style.width = Math.max(120, (val.length || 18) * 7.5) + 'px';
            // Update tab title
            document.title = (val ? val + ' ' : '') + '[' + sessionId + '] Claude Code';
          };
          input.oninput = function() {
            input.style.width = Math.max(120, (input.value.length || 18) * 7.5) + 'px';
          };
          input.onkeydown = function(e) { if (e.key === 'Enter') input.blur(); };

          row.appendChild(input);

          // Fork session button — copies session file server-side, opens new tab
          var forkBtn = document.createElement('button');
          forkBtn.title = 'Fork — copy this session and open in a new tab';
          forkBtn.innerHTML = '<svg width="12" height="12" viewBox="0 0 16 16" fill="currentColor" style="vertical-align:middle;margin-right:4px;"><path d="M5 3.25a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Zm0 2.122a2.25 2.25 0 1 0-1 0v1.836A2.489 2.489 0 0 0 4 9.5v.208a2.25 2.25 0 1 0 1 0V9.5a1.5 1.5 0 0 1 1.5-1.5h1A2.489 2.489 0 0 0 10 6.208V5.372a2.25 2.25 0 1 0-1 0v.836A1.5 1.5 0 0 1 7.5 7.5h-1A2.489 2.489 0 0 0 4 8.208V5.372ZM5 12.75a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Zm5.5-9.5a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Z"/></svg>Fork';
          forkBtn.style.cssText = 'border:none;cursor:pointer;padding:3px 10px;border-radius:5px;font-size:11px;font-weight:600;font-family:ui-sans-serif,system-ui,sans-serif;display:flex;align-items:center;transition:background 0.15s,opacity 0.15s;' +
            (dark ? 'background:#1e3a5f;color:#93c5fd;' : 'background:#eff6ff;color:#2563eb;');
          forkBtn.onmouseenter = function() { forkBtn.style.background = dark ? '#1e4080' : '#dbeafe'; };
          forkBtn.onmouseleave = function() { forkBtn.style.background = dark ? '#1e3a5f' : '#eff6ff'; };
          forkBtn.onclick = function() {
            // Get project encoded name
            var pathParts = window.location.pathname.match(/\/projects\/(.+)/);
            if (!pathParts) { alert('Cannot determine project path'); return; }
            var projectPath = decodeURIComponent(pathParts[1]);
            var encodedProject = projectPath.replace(/[/\\:._]/g, '-');

            // Resolve full session ID
            var fullId = window.__currentFullSessionId;
            forkBtn.textContent = '...';
            forkBtn.disabled = true;

            var doFork = function(resolvedId) {
              // Call server-side fork endpoint
              fetch('/api/fork', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ sessionId: resolvedId, encodedProjectName: encodedProject })
              })
              .then(function(r) { return r.json(); })
              .then(function(data) {
                if (data.error) { alert('Fork failed: ' + data.error); return; }
                // Open new tab pointing at the forked session — React loads it natively
                var url = new URL(window.location.href);
                url.searchParams.set('sessionId', data.newSessionId);
                url.searchParams.delete('view');
                url.searchParams.delete('fork');
                window.open(url.toString(), '_blank');
              })
              .catch(function(err) { alert('Fork error: ' + err.message); })
              .finally(function() {
                forkBtn.innerHTML = '<svg width="12" height="12" viewBox="0 0 16 16" fill="currentColor" style="vertical-align:middle;margin-right:4px;"><path d="M5 3.25a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Zm0 2.122a2.25 2.25 0 1 0-1 0v1.836A2.489 2.489 0 0 0 4 9.5v.208a2.25 2.25 0 1 0 1 0V9.5a1.5 1.5 0 0 1 1.5-1.5h1A2.489 2.489 0 0 0 10 6.208V5.372a2.25 2.25 0 1 0-1 0v.836A1.5 1.5 0 0 1 7.5 7.5h-1A2.489 2.489 0 0 0 4 8.208V5.372ZM5 12.75a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Zm5.5-9.5a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Z"/></svg>Fork';
                forkBtn.disabled = false;
              });
            };

            if (fullId && fullId.length > 8) {
              doFork(fullId);
            } else {
              // Look up full ID from histories first
              fetch('/api/projects/' + encodedProject + '/histories')
                .then(function(r) { return r.json(); })
                .then(function(data) {
                  var sessions = data.conversations || [];
                  for (var j = 0; j < sessions.length; j++) {
                    if (sessions[j].sessionId && sessions[j].sessionId.indexOf(sessionId) === 0) {
                      window.__currentFullSessionId = sessions[j].sessionId;
                      doFork(sessions[j].sessionId);
                      return;
                    }
                  }
                  alert('Could not find full session ID for ' + sessionId);
                  forkBtn.innerHTML = '<svg width="12" height="12" viewBox="0 0 16 16" fill="currentColor" style="vertical-align:middle;margin-right:4px;"><path d="M5 3.25a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Zm0 2.122a2.25 2.25 0 1 0-1 0v1.836A2.489 2.489 0 0 0 4 9.5v.208a2.25 2.25 0 1 0 1 0V9.5a1.5 1.5 0 0 1 1.5-1.5h1A2.489 2.489 0 0 0 10 6.208V5.372a2.25 2.25 0 1 0-1 0v.836A1.5 1.5 0 0 1 7.5 7.5h-1A2.489 2.489 0 0 0 4 8.208V5.372ZM5 12.75a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Zm5.5-9.5a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Z"/></svg>Fork';
                  forkBtn.disabled = false;
                })
                .catch(function(err) {
                  alert('Error: ' + err.message);
                  forkBtn.innerHTML = '<svg width="12" height="12" viewBox="0 0 16 16" fill="currentColor" style="vertical-align:middle;margin-right:4px;"><path d="M5 3.25a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Zm0 2.122a2.25 2.25 0 1 0-1 0v1.836A2.489 2.489 0 0 0 4 9.5v.208a2.25 2.25 0 1 0 1 0V9.5a1.5 1.5 0 0 1 1.5-1.5h1A2.489 2.489 0 0 0 10 6.208V5.372a2.25 2.25 0 1 0-1 0v.836A1.5 1.5 0 0 1 7.5 7.5h-1A2.489 2.489 0 0 0 4 8.208V5.372ZM5 12.75a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Zm5.5-9.5a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Z"/></svg>Fork';
                  forkBtn.disabled = false;
                });
            }
          };
          row.appendChild(forkBtn);

          // Insert: after header row if React rendered session span, or append to container
          if (sessionSpan) {
            headerRow.parentNode.insertBefore(row, headerRow.nextSibling);
          } else {
            headerRow.appendChild(row);
          }
        }

        // Use MutationObserver + polling to detect when session info appears in DOM
        var obs = new MutationObserver(function() {
          injectTitle();
        });

        window.addEventListener('load', function() {
          obs.observe(document.body, { childList: true, subtree: true });
          // Initial check + polling fallback (React re-renders can remove injected elements)
          setTimeout(injectTitle, 500);
          setInterval(injectTitle, 2000);
        });
      })();
    </script>
    <script>
      // Active directory chip — fixed-position, detects cd from multiple sources
      (function() {
        var DIR_KEY = 'claude-webui-active-dir';
        var PROJ_KEY = 'claude-webui-project-dirs';
        var chipLastVal = '';

        function isDark() { return document.documentElement.classList.contains('dark'); }

        function normalizePath(p) {
          if (!p) return '';
          p = p.trim().replace(/\s+&&.*/, '').replace(/\s+\|\|.*/, '');
          // Convert git-bash /c/path to C:\path
          var w = p.match(/^\/([a-z])\/(.*)/i);
          if (w) p = w[1].toUpperCase() + ':\\' + w[2].replace(/\//g, '\\');
          return p;
        }

        function setCwd(path) {
          var p = normalizePath(path);
          if (!p) return;
          localStorage.setItem(DIR_KEY, p);
          // Update tab title
          try {
            var items = JSON.parse(localStorage.getItem(PROJ_KEY)) || [];
            var hit = items.find(function(x) { return x.type === 'dir' && x.path === p; });
            if (window._autoTitleFromPath) window._autoTitleFromPath(p, hit ? hit.label : null);
          } catch(e) {}
        }

        // --- CHIP RENDERING ---
        function updateChip() {
          var activeDir = localStorage.getItem(DIR_KEY) || '';
          var chip = document.getElementById('cwd-chip');
          if (!activeDir) { if (chip) chip.style.display = 'none'; return; }
          // Try to place chip inside session-title-row if it exists
          var titleRow = document.getElementById('session-title-row');
          if (!chip) {
            chip = document.createElement('div');
            chip.id = 'cwd-chip';
            document.body.appendChild(chip);
          }
          var dark = isDark();
          if (titleRow && !titleRow.contains(chip)) {
            // Move into the title row — inline with session name + fork button
            chip.style.cssText = 'max-width:280px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;padding:2px 10px;border-radius:10px;font-size:10px;font-family:ui-monospace,monospace;cursor:default;user-select:all;margin-left:auto;';
            titleRow.appendChild(chip);
          } else if (!titleRow) {
            // Fallback: fixed position top-right when no session header
            chip.style.cssText = 'position:fixed;top:6px;right:160px;z-index:100001;max-width:320px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;padding:2px 10px;border-radius:10px;font-size:10px;font-family:ui-monospace,monospace;cursor:default;user-select:all;';
          }
          chip.style.display = 'block';
          chip.style.background = dark ? '#1e293b' : '#f1f5f9';
          chip.style.color = dark ? '#94a3b8' : '#64748b';
          chip.style.border = '1px solid ' + (dark ? '#334155' : '#e2e8f0');
          if (activeDir !== chipLastVal) {
            chipLastVal = activeDir;
            chip.textContent = activeDir;
            chip.title = activeDir;
          }
        }

        // --- DETECTION 1: Watch textarea for cd commands on form submit ---
        document.addEventListener('submit', function(e) {
          var form = e.target;
          if (!form) return;
          var ta = form.querySelector('textarea');
          if (!ta) return;
          var msg = (ta.value || '').trim();
          var cdMatch = msg.match(/^cd\s+(.+)/i);
          if (cdMatch) setCwd(cdMatch[1]);
        }, true);

        // --- DETECTION 2: Watch for Enter key on textarea (backup for submit) ---
        document.addEventListener('keydown', function(e) {
          if (e.key !== 'Enter' || e.shiftKey) return;
          var ta = e.target;
          if (!ta || ta.tagName !== 'TEXTAREA') return;
          var msg = (ta.value || '').trim();
          var cdMatch = msg.match(/^cd\s+(.+)/i);
          if (cdMatch) setCwd(cdMatch[1]);
        }, true);

        // --- DETECTION 3: Poll DOM text for init CWD (page load only) ---
        var initScanned = false;
        function scanInitCwd() {
          if (initScanned) return;
          var pres = document.querySelectorAll('pre');
          for (var i = 0; i < pres.length; i++) {
            var txt = pres[i].textContent || '';
            if (txt.indexOf('CWD:') !== -1) {
              var m = txt.match(/CWD:\s*(.+)/);
              if (m) {
                var d = m[1].trim();
                // Stop at newline content
                d = d.split('\n')[0].trim();
                initScanned = true;
                // Only set if no active dir already set
                if (!localStorage.getItem(DIR_KEY)) {
                  setCwd(d);
                }
                return;
              }
            }
          }
        }

        // --- DETECTION 4: Sidebar clicks already call setActiveDir directly ---
        // (no extra code needed, the chip polls localStorage)

        // Poll chip display every 300ms
        setInterval(updateChip, 300);

        window.addEventListener('load', function() {
          updateChip();
          // Scan for init CWD after React renders
          setTimeout(scanInitCwd, 1000);
          setTimeout(scanInitCwd, 2500);
          setTimeout(scanInitCwd, 5000);
        });
      })();
    </script>
    <script>
      // Tools Floater - draggable panel
      (function() {
        var CMDS_KEY = 'claude-webui-quick-cmds';
        var CMDS_COLLAPSED_KEY = 'claude-webui-cmds-collapsed';
        var POS_KEY = 'claude-webui-tools-pos';

        var DEFAULT_CMDS = [
          { label: 'Docker Rebuild', cmd: 'docker compose down && docker compose up --build' },
          { label: 'Git Push', cmd: 'git push' },
          { label: 'Git Pull', cmd: 'git pull' },
          { label: 'Git Status', cmd: 'git status' },
          { label: 'Commit', cmd: '/commit' },
          { label: 'Compact', cmd: '/compact' }
        ];

        function getCmds() {
          try {
            var stored = JSON.parse(localStorage.getItem(CMDS_KEY));
            return stored && stored.length ? stored : null;
          } catch { return null; }
        }
        function saveCmds(cmds) { localStorage.setItem(CMDS_KEY, JSON.stringify(cmds)); }
        function isCollapsed() { return localStorage.getItem(CMDS_COLLAPSED_KEY) === '1'; }
        function setCollapsed(v) { localStorage.setItem(CMDS_COLLAPSED_KEY, v ? '1' : '0'); }
        function isDark() { return document.documentElement.classList.contains('dark'); }
        function getPos() {
          try { return JSON.parse(localStorage.getItem(POS_KEY)) || { top: 40, left: 54 }; }
          catch { return { top: 40, left: 54 }; }
        }
        function savePos(pos) { localStorage.setItem(POS_KEY, JSON.stringify(pos)); }

        function sendToChat(text) {
          var ta = document.querySelector('textarea[placeholder="Type message..."]') ||
                   document.querySelector('textarea[placeholder="Processing..."]');
          if (!ta) return;
          var nativeSetter = Object.getOwnPropertyDescriptor(HTMLTextAreaElement.prototype, 'value').set;
          nativeSetter.call(ta, text);
          ta.dispatchEvent(new Event('input', { bubbles: true }));
          ta.focus();
          setTimeout(function() {
            var sendBtn = ta.closest('form') && ta.closest('form').querySelector('button[type="submit"]');
            if (sendBtn && !sendBtn.disabled) sendBtn.click();
          }, 50);
        }

        function showToast(msg) {
          var t = document.createElement('div');
          t.textContent = msg;
          var dk = isDark();
          t.style.cssText = 'position:fixed;bottom:20px;left:50%;transform:translateX(-50%);padding:8px 16px;border-radius:8px;font-size:13px;z-index:100000;transition:opacity 0.3s;pointer-events:none;' +
            (dk ? 'background:#334155;color:#e2e8f0;' : 'background:#1e293b;color:#f1f5f9;');
          document.body.appendChild(t);
          setTimeout(function() { t.style.opacity = '0'; }, 1200);
          setTimeout(function() { t.remove(); }, 1500);
        }

        function render() {
          var existing = document.getElementById('cmds-floater');
          if (existing) existing.remove();
          var toggleExisting = document.getElementById('cmds-floater-toggle');
          if (toggleExisting) toggleExisting.remove();

          var dark = isDark();
          var collapsed = isCollapsed();
          var cmds = getCmds() || DEFAULT_CMDS;
          var pos = getPos();

          // Toggle button (only shown when collapsed)
          var toggleBtn = document.createElement('button');
          toggleBtn.id = 'cmds-floater-toggle';
          toggleBtn.innerHTML = '&#x26A1;';
          toggleBtn.title = 'Open tools';
          toggleBtn.style.cssText = 'position:fixed;top:8px;left:8px;z-index:100001;border:1px solid ' + (dark ? 'rgba(148,163,184,0.3)' : 'rgba(128,128,128,0.3)') + ';border-radius:6px;cursor:pointer;font-size:14px;padding:4px 8px;opacity:0.6;transition:opacity 0.2s;background:' + (dark ? '#1e293b' : '#fff') + ';color:' + (dark ? '#e2e8f0' : '#334155') + ';';
          toggleBtn.onmouseenter = function() { toggleBtn.style.opacity = '1'; };
          toggleBtn.onmouseleave = function() { toggleBtn.style.opacity = '0.6'; };
          toggleBtn.onclick = function() { setCollapsed(false); render(); };

          if (collapsed) {
            document.body.appendChild(toggleBtn);
            return;
          }

          // Panel
          var panel = document.createElement('div');
          panel.id = 'cmds-floater';
          panel.style.cssText = 'position:fixed;top:' + pos.top + 'px;left:' + pos.left + 'px;width:180px;z-index:100000;border-radius:10px;border:1px solid ' + (dark ? '#334155' : '#e2e8f0') + ';font-family:ui-sans-serif,system-ui,sans-serif;font-size:13px;overflow:visible;box-shadow:0 4px 12px rgba(0,0,0,0.1);' +
            (dark ? 'background:#0f172a;color:#e2e8f0;' : 'background:#f8fafc;color:#1e293b;');

          // Header (draggable to move panel)
          var header = document.createElement('div');
          header.style.cssText = 'padding:10px 12px 6px;font-weight:600;font-size:11px;text-transform:uppercase;letter-spacing:0.05em;color:' + (dark ? '#94a3b8' : '#64748b') + ';display:flex;justify-content:space-between;align-items:center;cursor:grab;user-select:none;';
          var headerText = document.createElement('span');
          headerText.textContent = 'Tools';
          header.appendChild(headerText);

          // Panel dragging via header
          var dragging = false, dragOffX = 0, dragOffY = 0;
          header.onmousedown = function(e) {
            if (e.target !== header && e.target !== headerText) return;
            dragging = true;
            dragOffX = e.clientX - panel.getBoundingClientRect().left;
            dragOffY = e.clientY - panel.getBoundingClientRect().top;
            header.style.cursor = 'grabbing';
            e.preventDefault();
          };
          document.addEventListener('mousemove', function(e) {
            if (!dragging) return;
            var newLeft = Math.max(0, Math.min(window.innerWidth - 190, e.clientX - dragOffX));
            var newTop = Math.max(0, Math.min(window.innerHeight - 100, e.clientY - dragOffY));
            panel.style.left = newLeft + 'px';
            panel.style.top = newTop + 'px';
          });
          document.addEventListener('mouseup', function() {
            if (!dragging) return;
            dragging = false;
            header.style.cursor = 'grab';
            savePos({ top: parseInt(panel.style.top), left: parseInt(panel.style.left) });
          });

          // Header buttons container
          var headerBtns = document.createElement('div');
          headerBtns.style.cssText = 'display:flex;gap:4px;align-items:center;';

          // Add command button
          var editBtn = document.createElement('button');
          editBtn.textContent = '+';
          editBtn.title = 'Add command';
          editBtn.style.cssText = 'border:none;background:none;cursor:pointer;font-size:16px;font-weight:600;padding:0 2px;color:' + (dark ? '#94a3b8' : '#64748b') + ';';
          editBtn.onclick = function() {
            var label = prompt('Command label:');
            if (!label) return;
            var cmd = prompt('Command to paste:');
            if (!cmd) return;
            cmds.push({ label: label, cmd: cmd });
            saveCmds(cmds);
            render();
          };
          headerBtns.appendChild(editBtn);

          // Close button (inside header)
          var closeBtn = document.createElement('button');
          closeBtn.innerHTML = '&times;';
          closeBtn.title = 'Close tools';
          closeBtn.style.cssText = 'border:none;background:none;cursor:pointer;font-size:16px;font-weight:600;padding:0 2px;color:' + (dark ? '#94a3b8' : '#64748b') + ';';
          closeBtn.onclick = function() { setCollapsed(true); render(); };
          headerBtns.appendChild(closeBtn);

          header.appendChild(headerBtns);
          panel.appendChild(header);

          // Command list (items draggable to reorder)
          var dragIdx = null;
          var list = document.createElement('div');
          list.style.cssText = 'padding:2px 6px 4px;display:flex;flex-direction:column;gap:2px;';

          cmds.forEach(function(item, idx) {
            var row = document.createElement('div');
            row.draggable = true;
            row.dataset.idx = idx;
            row.style.cssText = 'display:flex;align-items:center;gap:4px;transition:opacity 0.15s;';

            // Drag handle for reordering
            var handle = document.createElement('span');
            handle.textContent = '\u2261';
            handle.style.cssText = 'cursor:grab;font-size:14px;padding:0 2px;opacity:0.3;color:' + (dark ? '#94a3b8' : '#64748b') + ';flex-shrink:0;user-select:none;';
            handle.onmouseenter = function() { handle.style.opacity = '0.7'; };
            handle.onmouseleave = function() { handle.style.opacity = '0.3'; };
            row.appendChild(handle);

            row.ondragstart = function(e) {
              dragIdx = idx;
              e.dataTransfer.effectAllowed = 'move';
              row.style.opacity = '0.4';
            };
            row.ondragend = function() {
              row.style.opacity = '1';
              dragIdx = null;
              list.querySelectorAll('[data-idx]').forEach(function(r) {
                r.style.borderTop = 'none';
                r.style.borderBottom = 'none';
              });
            };
            row.ondragover = function(e) {
              e.preventDefault();
              e.dataTransfer.dropEffect = 'move';
              var targetIdx = parseInt(row.dataset.idx);
              list.querySelectorAll('[data-idx]').forEach(function(r) {
                r.style.borderTop = 'none';
                r.style.borderBottom = 'none';
              });
              if (dragIdx !== null && targetIdx !== dragIdx) {
                if (targetIdx < dragIdx) row.style.borderTop = '2px solid #3b82f6';
                else row.style.borderBottom = '2px solid #3b82f6';
              }
            };
            row.ondrop = function(e) {
              e.preventDefault();
              var targetIdx = parseInt(row.dataset.idx);
              if (dragIdx !== null && dragIdx !== targetIdx) {
                var moved = cmds.splice(dragIdx, 1)[0];
                cmds.splice(targetIdx, 0, moved);
                saveCmds(cmds);
                render();
              }
            };

            var hotkeyNum = idx + 1;

            var btn = document.createElement('button');
            btn.innerHTML = '<span style="display:inline-block;min-width:16px;font-size:10px;opacity:0.5;margin-right:4px;">' + (hotkeyNum <= 9 ? hotkeyNum : '') + '</span>' + item.label;
            btn.title = item.cmd + (hotkeyNum <= 9 ? ' (Alt+' + hotkeyNum + ')' : '');
            btn.style.cssText = 'flex:1;text-align:left;padding:6px 10px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:500;border:none;transition:background 0.15s;' +
              (dark ? 'background:#1e293b;color:#e2e8f0;' : 'background:#e2e8f0;color:#1e293b;');
            btn.onmouseenter = function() { btn.style.background = dark ? '#334155' : '#cbd5e1'; };
            btn.onmouseleave = function() { btn.style.background = dark ? '#1e293b' : '#e2e8f0'; };
            btn.onclick = function() {
              sendToChat(item.cmd);
              showToast(item.label);
            };
            row.appendChild(btn);

            var delBtn = document.createElement('button');
            delBtn.innerHTML = '&times;';
            delBtn.title = 'Remove';
            delBtn.style.cssText = 'border:none;background:none;cursor:pointer;font-size:14px;padding:0 2px;opacity:0.25;transition:opacity 0.15s;color:' + (dark ? '#94a3b8' : '#64748b') + ';flex-shrink:0;';
            delBtn.onmouseenter = function() { delBtn.style.opacity = '1'; delBtn.style.color = dark ? '#f87171' : '#ef4444'; };
            delBtn.onmouseleave = function() { delBtn.style.opacity = '0.25'; delBtn.style.color = dark ? '#94a3b8' : '#64748b'; };
            delBtn.onclick = function() {
              cmds.splice(idx, 1);
              saveCmds(cmds);
              render();
            };
            row.appendChild(delBtn);

            list.appendChild(row);
          });

          panel.appendChild(list);

          // Reset link
          var resetRow = document.createElement('div');
          resetRow.style.cssText = 'padding:4px 12px 8px;text-align:center;';
          var resetLink = document.createElement('button');
          resetLink.textContent = 'Reset defaults';
          resetLink.style.cssText = 'border:none;background:none;cursor:pointer;font-size:10px;color:' + (dark ? '#475569' : '#94a3b8') + ';';
          resetLink.onclick = function() {
            localStorage.removeItem(CMDS_KEY);
            render();
          };
          resetRow.appendChild(resetLink);
          panel.appendChild(resetRow);

          document.body.appendChild(panel);
        }

        // Alt+number hotkeys for commands
        document.addEventListener('keydown', function(e) {
          if (!e.altKey || e.ctrlKey || e.shiftKey || e.metaKey) return;
          var num = parseInt(e.key);
          if (isNaN(num) || num < 1 || num > 9) return;
          var tag = document.activeElement && document.activeElement.tagName;
          if (tag === 'INPUT') return;
          var cmds = getCmds() || DEFAULT_CMDS;
          var idx = num - 1;
          if (idx < cmds.length) {
            e.preventDefault();
            sendToChat(cmds[idx].cmd);
            showToast(cmds[idx].label);
          }
        });

        // Watch for dark mode changes
        var observer = new MutationObserver(function(mutations) {
          mutations.forEach(function(m) {
            if (m.attributeName === 'class') render();
          });
        });

        window.addEventListener('load', function() {
          render();
          observer.observe(document.documentElement, { attributes: true });
        });
      })();
    </script>

    <!-- Right-side utility toolbar -->
    <script>
      (function() {
        var AUTOSCROLL_KEY = 'claude-webui-autoscroll';
        var FONTSIZE_KEY = 'claude-webui-fontsize';
        var NOTIFY_KEY = 'claude-webui-notify-sound';
        var JOB_QUEUE_KEY = 'claude-webui-job-queue';
        var FONT_STEPS = [12, 13, 14, 15, 16, 18, 20];
        var DEFAULT_FONT_IDX = 2; // 14px

        function isDark() { return document.documentElement.classList.contains('dark'); }
        function isAutoScroll() { return localStorage.getItem(AUTOSCROLL_KEY) !== '0'; }
        function setAutoScroll(v) { localStorage.setItem(AUTOSCROLL_KEY, v ? '1' : '0'); }
        function isNotifyEnabled() { return localStorage.getItem(NOTIFY_KEY) === '1'; }
        function setNotifyEnabled(v) { localStorage.setItem(NOTIFY_KEY, v ? '1' : '0'); }

        // Notification sound using Web Audio API
        function playNotifySound() {
          try {
            var ctx = new (window.AudioContext || window.webkitAudioContext)();
            // Pleasant two-tone chime
            function playTone(freq, start, duration, gain) {
              var osc = ctx.createOscillator();
              var vol = ctx.createGain();
              osc.type = 'sine';
              osc.frequency.value = freq;
              vol.gain.setValueAtTime(gain, ctx.currentTime + start);
              vol.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + start + duration);
              osc.connect(vol);
              vol.connect(ctx.destination);
              osc.start(ctx.currentTime + start);
              osc.stop(ctx.currentTime + start + duration);
            }
            playTone(587, 0, 0.15, 0.3);     // D5
            playTone(880, 0.12, 0.2, 0.25);   // A5
          } catch(e) {}
        }

        // --- Job Queue Engine (Multi-Plan) ---
        // sendToChat helper (duplicated since the sidebar's version is scoped)
        function sendToChat(text) {
          var ta = document.querySelector('textarea[placeholder="Type message..."]') ||
                   document.querySelector('textarea[placeholder="Processing..."]');
          if (!ta) return;
          var nativeSetter = Object.getOwnPropertyDescriptor(HTMLTextAreaElement.prototype, 'value').set;
          nativeSetter.call(ta, text);
          ta.dispatchEvent(new Event('input', { bubbles: true }));
          ta.focus();
          setTimeout(function() {
            var sendBtn = ta.closest('form') && ta.closest('form').querySelector('button[type="submit"]');
            if (sendBtn && !sendBtn.disabled) sendBtn.click();
          }, 50);
        }

        // Plans stored in localStorage (shared across tabs)
        // { plans: [ { id, name, jobs: [{ prompt, status }] } ] }
        function getAllPlans() {
          try {
            var raw = JSON.parse(localStorage.getItem(JOB_QUEUE_KEY));
            if (!raw || !Array.isArray(raw.plans)) return { plans: [] };
            return raw;
          } catch(e) { return { plans: [] }; }
        }
        function saveAllPlans(data) { localStorage.setItem(JOB_QUEUE_KEY, JSON.stringify(data)); }
        function getPlan(planId) {
          var data = getAllPlans();
          for (var i = 0; i < data.plans.length; i++) {
            if (data.plans[i].id === planId) return data.plans[i];
          }
          return null;
        }
        function savePlan(plan) {
          var data = getAllPlans();
          for (var i = 0; i < data.plans.length; i++) {
            if (data.plans[i].id === plan.id) { data.plans[i] = plan; saveAllPlans(data); return; }
          }
          data.plans.push(plan);
          saveAllPlans(data);
        }
        function deletePlan(planId) {
          var data = getAllPlans();
          data.plans = data.plans.filter(function(p) { return p.id !== planId; });
          saveAllPlans(data);
          if (getActivePlanId() === planId) setActivePlanId('');
          if (getSelectedPlanId() === planId) setSelectedPlanId('');
        }
        function genPlanId() { return 'plan_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5); }

        // Active plan for THIS tab (sessionStorage = per-tab)
        function getActivePlanId() { return sessionStorage.getItem('claude-webui-active-plan') || ''; }
        function setActivePlanId(id) { sessionStorage.setItem('claude-webui-active-plan', id); }
        // Selected plan in panel (for viewing/editing)
        function getSelectedPlanId() { return sessionStorage.getItem('claude-webui-selected-plan') || ''; }
        function setSelectedPlanId(id) { sessionStorage.setItem('claude-webui-selected-plan', id); }

        var jobQueueRunning = false;
        var jobQueueWaitingForStart = false;

        function startPlan(planId) {
          setActivePlanId(planId);
          jobQueueRunning = true;
          runNextJob();
        }
        function pausePlan() {
          jobQueueRunning = false;
          setActivePlanId('');
          updateJobQueuePanel();
        }
        function runNextJob() {
          if (!jobQueueRunning) { updateJobQueuePanel(); return; }
          var planId = getActivePlanId();
          var plan = planId ? getPlan(planId) : null;
          if (!plan) { jobQueueRunning = false; updateJobQueuePanel(); return; }
          var nextJob = null;
          for (var i = 0; i < plan.jobs.length; i++) {
            if (plan.jobs[i].status === 'pending') { nextJob = plan.jobs[i]; break; }
          }
          if (!nextJob) {
            jobQueueRunning = false;
            setActivePlanId('');
            updateJobQueuePanel();
            if (isNotifyEnabled()) playNotifySound();
            return;
          }
          nextJob.status = 'running';
          savePlan(plan);
          updateJobQueuePanel();
          sendToChat(nextJob.prompt);
          jobQueueWaitingForStart = true;
        }
        function onJobComplete() {
          var planId = getActivePlanId();
          var plan = planId ? getPlan(planId) : null;
          if (!plan) return;
          for (var i = 0; i < plan.jobs.length; i++) {
            if (plan.jobs[i].status === 'running') { plan.jobs[i].status = 'done'; break; }
          }
          savePlan(plan);
          updateJobQueuePanel();
          if (jobQueueRunning) {
            setTimeout(runNextJob, 1500);
          }
        }

        // Watch for response completion (notification + job queue)
        var wasProcessing = false;
        function checkProcessingState() {
          var ta = document.querySelector('textarea[placeholder="Processing..."]');
          var isProcessing = !!ta;
          if (wasProcessing && !isProcessing && isNotifyEnabled() && document.hidden) {
            playNotifySound();
          }
          if (!wasProcessing && isProcessing && jobQueueWaitingForStart) {
            jobQueueWaitingForStart = false;
          }
          if (wasProcessing && !isProcessing && jobQueueRunning) {
            onJobComplete();
          }
          wasProcessing = isProcessing;
        }
        setInterval(checkProcessingState, 500);
        function getFontIdx() {
          var stored = parseInt(localStorage.getItem(FONTSIZE_KEY));
          return isNaN(stored) ? DEFAULT_FONT_IDX : Math.max(0, Math.min(FONT_STEPS.length - 1, stored));
        }
        function setFontIdx(idx) { localStorage.setItem(FONTSIZE_KEY, idx); }
        function applyFontSize() {
          var size = FONT_STEPS[getFontIdx()];
          document.getElementById('root').style.fontSize = size + 'px';
        }

        function getChatContainer() {
          var candidates = document.querySelectorAll('div');
          for (var i = 0; i < candidates.length; i++) {
            var el = candidates[i];
            var style = window.getComputedStyle(el);
            if ((style.overflowY === 'auto' || style.overflowY === 'scroll') &&
                el.scrollHeight > el.clientHeight + 50 &&
                el.clientHeight > 200) {
              return el;
            }
          }
          return null;
        }

        function scrollToBottom() {
          var container = getChatContainer();
          if (container) container.scrollTop = container.scrollHeight;
        }

        var scrollObserver = null;
        function setupScrollObserver() {
          if (scrollObserver) scrollObserver.disconnect();
          scrollObserver = new MutationObserver(function() {
            if (isAutoScroll()) scrollToBottom();
          });
          scrollObserver.observe(document.body, { childList: true, subtree: true, characterData: true });
        }

        function render() {
          var existing = document.getElementById('util-toolbar');
          if (existing) existing.remove();

          var dark = isDark();
          var autoScroll = isAutoScroll();

          var toolbar = document.createElement('div');
          toolbar.id = 'util-toolbar';
          toolbar.style.cssText = 'position:fixed;left:8px;top:40px;z-index:100000;display:flex;flex-direction:column;gap:4px;padding:4px;border-radius:10px;border:1px solid ' + (dark ? '#334155' : '#e2e8f0') + ';box-shadow:0 2px 8px rgba(0,0,0,0.08);' +
            (dark ? 'background:#0f172a;' : 'background:#f8fafc;');

          var scrollBtn = document.createElement('button');
          scrollBtn.innerHTML = autoScroll ? '&#x2B07;&#xFE0F;' : '&#x23F8;&#xFE0F;';
          scrollBtn.title = autoScroll ? 'Auto-scroll ON (click to pause)' : 'Auto-scroll OFF (click to resume)';
          scrollBtn.style.cssText = 'width:36px;height:36px;border:none;border-radius:8px;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;transition:background 0.15s;background:transparent;' +
            (autoScroll ? 'opacity:1;' : 'opacity:0.5;');
          scrollBtn.onmouseenter = function() { scrollBtn.style.background = dark ? '#1e293b' : '#e2e8f0'; };
          scrollBtn.onmouseleave = function() { scrollBtn.style.background = 'transparent'; };
          scrollBtn.onclick = function() {
            setAutoScroll(!autoScroll);
            if (!autoScroll) scrollToBottom();
            render();
          };
          toolbar.appendChild(scrollBtn);

          var renameBtn = document.createElement('button');
          renameBtn.innerHTML = '&#x270F;&#xFE0F;';
          renameBtn.title = 'Rename tab (F2)';
          renameBtn.style.cssText = 'width:36px;height:36px;border:none;border-radius:8px;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;transition:background 0.15s;background:transparent;';
          renameBtn.onmouseenter = function() { renameBtn.style.background = dark ? '#1e293b' : '#e2e8f0'; };
          renameBtn.onmouseleave = function() { renameBtn.style.background = 'transparent'; };
          renameBtn.onclick = function() { if (window._renameTab) window._renameTab(); };
          toolbar.appendChild(renameBtn);

          // Font size increase
          var fontIdx = getFontIdx();
          var fontUpBtn = document.createElement('button');
          fontUpBtn.textContent = 'A+';
          fontUpBtn.title = 'Increase font size (' + FONT_STEPS[fontIdx] + 'px)';
          fontUpBtn.style.cssText = 'width:36px;height:36px;border:none;border-radius:8px;cursor:pointer;font-size:12px;font-weight:700;display:flex;align-items:center;justify-content:center;transition:background 0.15s;background:transparent;' +
            (dark ? 'color:#e2e8f0;' : 'color:#1e293b;') +
            (fontIdx >= FONT_STEPS.length - 1 ? 'opacity:0.3;cursor:default;' : '');
          fontUpBtn.onmouseenter = function() { if (fontIdx < FONT_STEPS.length - 1) fontUpBtn.style.background = dark ? '#1e293b' : '#e2e8f0'; };
          fontUpBtn.onmouseleave = function() { fontUpBtn.style.background = 'transparent'; };
          fontUpBtn.onclick = function() {
            if (fontIdx >= FONT_STEPS.length - 1) return;
            setFontIdx(fontIdx + 1);
            applyFontSize();
            render();
          };
          toolbar.appendChild(fontUpBtn);

          // Font size decrease
          var fontDownBtn = document.createElement('button');
          fontDownBtn.textContent = 'A-';
          fontDownBtn.title = 'Decrease font size (' + FONT_STEPS[fontIdx] + 'px)';
          fontDownBtn.style.cssText = 'width:36px;height:36px;border:none;border-radius:8px;cursor:pointer;font-size:12px;font-weight:700;display:flex;align-items:center;justify-content:center;transition:background 0.15s;background:transparent;' +
            (dark ? 'color:#e2e8f0;' : 'color:#1e293b;') +
            (fontIdx <= 0 ? 'opacity:0.3;cursor:default;' : '');
          fontDownBtn.onmouseenter = function() { if (fontIdx > 0) fontDownBtn.style.background = dark ? '#1e293b' : '#e2e8f0'; };
          fontDownBtn.onmouseleave = function() { fontDownBtn.style.background = 'transparent'; };
          fontDownBtn.onclick = function() {
            if (fontIdx <= 0) return;
            setFontIdx(fontIdx - 1);
            applyFontSize();
            render();
          };
          toolbar.appendChild(fontDownBtn);

          // Open CLAUDE.md button
          var claudeBtn = document.createElement('button');
          claudeBtn.innerHTML = '&#x1F4CB;';
          claudeBtn.title = 'Open CLAUDE.md (F4)';
          claudeBtn.style.cssText = 'width:36px;height:36px;border:none;border-radius:8px;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;transition:background 0.15s;background:transparent;';
          claudeBtn.onmouseenter = function() { claudeBtn.style.background = dark ? '#1e293b' : '#e2e8f0'; };
          claudeBtn.onmouseleave = function() { claudeBtn.style.background = 'transparent'; };
          claudeBtn.onclick = function() { window._openClaudeMd(); };
          toolbar.appendChild(claudeBtn);

          // Notification sound toggle
          var notifyOn = isNotifyEnabled();
          var notifyBtn = document.createElement('button');
          notifyBtn.innerHTML = notifyOn ? '&#x1F514;' : '&#x1F515;';
          notifyBtn.title = notifyOn ? 'Sound ON (click to mute)' : 'Sound OFF (click to enable)';
          notifyBtn.style.cssText = 'width:36px;height:36px;border:none;border-radius:8px;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;transition:background 0.15s;background:transparent;' +
            (notifyOn ? 'opacity:1;' : 'opacity:0.5;');
          notifyBtn.onmouseenter = function() { notifyBtn.style.background = dark ? '#1e293b' : '#e2e8f0'; };
          notifyBtn.onmouseleave = function() { notifyBtn.style.background = 'transparent'; };
          notifyBtn.onclick = function() {
            setNotifyEnabled(!notifyOn);
            if (!notifyOn) playNotifySound(); // preview the sound when enabling
            render();
          };
          toolbar.appendChild(notifyBtn);

          // Job Queue toggle button
          var queueBtn = document.createElement('button');
          queueBtn.textContent = 'Q';
          queueBtn.title = 'Job Queue';
          queueBtn.style.cssText = 'width:36px;height:36px;border:none;border-radius:8px;cursor:pointer;font-size:14px;font-weight:700;display:flex;align-items:center;justify-content:center;transition:background 0.15s;background:transparent;' +
            (dark ? 'color:#e2e8f0;' : 'color:#1e293b;') +
            (jobQueueRunning ? 'color:#3b82f6;' : '');
          queueBtn.onmouseenter = function() { queueBtn.style.background = dark ? '#1e293b' : '#e2e8f0'; };
          queueBtn.onmouseleave = function() { queueBtn.style.background = 'transparent'; };
          queueBtn.onclick = function() { toggleJobQueuePanel(); };
          toolbar.appendChild(queueBtn);

          document.body.appendChild(toolbar);
        }

        // Open CLAUDE.md in default editor
        window._openClaudeMd = function() {
          var activeDir = localStorage.getItem('claude-webui-active-dir');
          if (!activeDir) {
            alert('No active project selected. Click a project in the sidebar first.');
            return;
          }
          var sep = activeDir.indexOf('\\') !== -1 ? '\\' : '/';
          var filePath = activeDir + sep + 'CLAUDE.md';
          fetch('/api/open-file', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ filePath: filePath })
          }).then(function(r) { return r.json(); }).then(function(data) {
            if (data.error) alert('Could not open CLAUDE.md: ' + data.error);
          }).catch(function() { alert('Failed to open CLAUDE.md'); });
        };

        // F4 hotkey
        document.addEventListener('keydown', function(e) {
          if (e.key === 'F4' && !e.ctrlKey && !e.altKey && !e.shiftKey) {
            e.preventDefault();
            window._openClaudeMd();
          }
        });

        // --- Job Queue Panel (Multi-Plan) ---
        var jobQueuePanelVisible = false;
        function toggleJobQueuePanel() {
          jobQueuePanelVisible = !jobQueuePanelVisible;
          updateJobQueuePanel();
        }
        function updateJobQueuePanel() {
          var existing = document.getElementById('job-queue-panel');
          if (existing) existing.remove();
          if (!jobQueuePanelVisible) return;
          var dark = isDark();
          var data = getAllPlans();
          var selId = getSelectedPlanId();
          var selPlan = selId ? getPlan(selId) : null;
          var actId = getActivePlanId();
          var btnCss = 'border:none;border-radius:6px;font-size:13px;font-weight:500;cursor:pointer;padding:6px 12px;';

          var panel = document.createElement('div');
          panel.id = 'job-queue-panel';
          panel.style.cssText = 'position:fixed;right:0;top:0;bottom:0;width:420px;z-index:100001;display:flex;flex-direction:column;border-left:1px solid ' + (dark ? '#334155' : '#e2e8f0') + ';box-shadow:-4px 0 16px rgba(0,0,0,0.2);' +
            (dark ? 'background:#0f172a;color:#e2e8f0;' : 'background:#f8fafc;color:#1e293b;');

          // Header
          var hdr = document.createElement('div');
          hdr.style.cssText = 'padding:14px 16px;border-bottom:1px solid ' + (dark ? '#334155' : '#e2e8f0') + ';display:flex;align-items:center;justify-content:space-between;flex-shrink:0;';
          var ttl = document.createElement('div');
          ttl.style.cssText = 'font-size:15px;font-weight:600;';
          ttl.textContent = 'Job Queue';
          hdr.appendChild(ttl);
          var xBtn = document.createElement('button');
          xBtn.innerHTML = '&times;';
          xBtn.style.cssText = 'border:none;background:none;font-size:20px;cursor:pointer;padding:0 4px;' + (dark ? 'color:#94a3b8;' : 'color:#64748b;');
          xBtn.onclick = toggleJobQueuePanel;
          hdr.appendChild(xBtn);
          panel.appendChild(hdr);

          // Plan list / selector
          var planBar = document.createElement('div');
          planBar.style.cssText = 'padding:10px 16px;border-bottom:1px solid ' + (dark ? '#334155' : '#e2e8f0') + ';flex-shrink:0;';
          var planRow = document.createElement('div');
          planRow.style.cssText = 'display:flex;flex-wrap:wrap;gap:6px;align-items:center;';
          data.plans.forEach(function(p) {
            var isSel = p.id === selId;
            var isAct = p.id === actId && jobQueueRunning;
            var chip = document.createElement('button');
            chip.style.cssText = btnCss + 'padding:4px 10px;font-size:12px;' +
              (isSel ? 'background:#3b82f6;color:#fff;' :
               (dark ? 'background:#1e293b;color:#e2e8f0;border:1px solid #334155;' : 'background:#fff;color:#1e293b;border:1px solid #e2e8f0;')) +
              (isAct && !isSel ? 'border-color:#3b82f6;' : '');
            var dc = 0, tc = p.jobs.length;
            for (var j = 0; j < tc; j++) { if (p.jobs[j].status === 'done') dc++; }
            chip.textContent = p.name + (tc > 0 ? ' (' + dc + '/' + tc + ')' : '') + (isAct ? ' \u25B6' : '');
            (function(pid) { chip.onclick = function() { setSelectedPlanId(pid); updateJobQueuePanel(); }; })(p.id);
            planRow.appendChild(chip);
          });
          // New plan button
          var newBtn = document.createElement('button');
          newBtn.textContent = '+';
          newBtn.title = 'Create new plan';
          newBtn.style.cssText = btnCss + 'padding:4px 10px;font-size:14px;font-weight:700;' +
            (dark ? 'background:#334155;color:#e2e8f0;' : 'background:#e2e8f0;color:#1e293b;');
          newBtn.onclick = function() {
            var name = prompt('Plan name:');
            if (!name || !name.trim()) return;
            var np = { id: genPlanId(), name: name.trim(), jobs: [] };
            savePlan(np);
            setSelectedPlanId(np.id);
            updateJobQueuePanel();
          };
          planRow.appendChild(newBtn);
          planBar.appendChild(planRow);
          panel.appendChild(planBar);

          // Selected plan content
          if (!selPlan) {
            var noSel = document.createElement('div');
            noSel.style.cssText = 'flex:1;display:flex;align-items:center;justify-content:center;opacity:0.4;font-size:13px;';
            noSel.textContent = data.plans.length === 0 ? 'Click + to create a plan' : 'Select a plan above';
            panel.appendChild(noSel);
          } else {
            // Plan header with name + controls
            var planHdr = document.createElement('div');
            planHdr.style.cssText = 'padding:10px 16px;border-bottom:1px solid ' + (dark ? '#334155' : '#e2e8f0') + ';display:flex;align-items:center;gap:8px;flex-shrink:0;';
            var planName = document.createElement('div');
            planName.style.cssText = 'flex:1;font-size:14px;font-weight:600;';
            planName.textContent = selPlan.name;
            planHdr.appendChild(planName);
            // Rename
            var renBtn = document.createElement('button');
            renBtn.textContent = 'Rename';
            renBtn.style.cssText = btnCss + 'font-size:11px;padding:3px 8px;' + (dark ? 'background:#334155;color:#94a3b8;' : 'background:#e2e8f0;color:#64748b;');
            (function(pid) { renBtn.onclick = function() {
              var nn = prompt('New name:', selPlan.name);
              if (!nn || !nn.trim()) return;
              var p = getPlan(pid); if (p) { p.name = nn.trim(); savePlan(p); updateJobQueuePanel(); }
            }; })(selPlan.id);
            planHdr.appendChild(renBtn);
            // Delete plan
            var delPBtn = document.createElement('button');
            delPBtn.textContent = 'Delete';
            delPBtn.style.cssText = btnCss + 'font-size:11px;padding:3px 8px;' + (dark ? 'background:#334155;color:#f87171;' : 'background:#fee2e2;color:#ef4444;');
            (function(pid) { delPBtn.onclick = function() {
              if (!confirm('Delete plan "' + selPlan.name + '"?')) return;
              if (actId === pid) pausePlan();
              deletePlan(pid);
              updateJobQueuePanel();
            }; })(selPlan.id);
            planHdr.appendChild(delPBtn);
            panel.appendChild(planHdr);

            // Add job input
            var addRow = document.createElement('div');
            addRow.style.cssText = 'padding:10px 16px;border-bottom:1px solid ' + (dark ? '#334155' : '#e2e8f0') + ';flex-shrink:0;';
            var jobInput = document.createElement('textarea');
            jobInput.placeholder = 'Enter job prompt...';
            jobInput.style.cssText = 'width:100%;min-height:50px;padding:8px;border:1px solid ' + (dark ? '#334155' : '#cbd5e1') + ';border-radius:6px;font-size:13px;font-family:inherit;resize:vertical;box-sizing:border-box;' +
              (dark ? 'background:#1e293b;color:#e2e8f0;' : 'background:#fff;color:#1e293b;');
            addRow.appendChild(jobInput);
            var addBtnRow = document.createElement('div');
            addBtnRow.style.cssText = 'margin-top:6px;';
            var addBtn = document.createElement('button');
            addBtn.textContent = '+ Add Job';
            addBtn.style.cssText = btnCss + (dark ? 'background:#334155;color:#e2e8f0;' : 'background:#e2e8f0;color:#1e293b;');
            (function(pid) { addBtn.onclick = function() {
              var text = jobInput.value.trim();
              if (!text) return;
              var p = getPlan(pid); if (!p) return;
              p.jobs.push({ prompt: text, status: 'pending' });
              savePlan(p);
              jobInput.value = '';
              updateJobQueuePanel();
            }; })(selPlan.id);
            addBtnRow.appendChild(addBtn);
            addRow.appendChild(addBtnRow);
            panel.appendChild(addRow);

            // Job list
            var listWrap = document.createElement('div');
            listWrap.style.cssText = 'flex:1;overflow-y:auto;padding:8px 16px;';
            if (selPlan.jobs.length === 0) {
              var empty = document.createElement('div');
              empty.style.cssText = 'text-align:center;padding:32px 0;opacity:0.4;font-size:13px;';
              empty.textContent = 'No jobs yet. Add prompts above.';
              listWrap.appendChild(empty);
            }
            var isThisPlanRunning = jobQueueRunning && actId === selPlan.id;
            selPlan.jobs.forEach(function(job, idx) {
              var isRun = job.status === 'running';
              var isDn = job.status === 'done';
              var card = document.createElement('div');
              card.style.cssText = 'padding:10px 12px;margin-bottom:6px;border-radius:8px;border:1px solid ' +
                (isRun ? '#3b82f6' : (dark ? '#334155' : '#e2e8f0')) +
                ';display:flex;align-items:flex-start;gap:10px;' +
                (isRun ? (dark ? 'background:#1e3a5f;' : 'background:#eff6ff;') : (dark ? 'background:#1e293b;' : 'background:#fff;')) +
                (isDn ? 'opacity:0.45;' : '');

              var ic = document.createElement('div');
              ic.style.cssText = 'flex-shrink:0;width:22px;text-align:center;font-size:13px;padding-top:2px;font-weight:600;' +
                (isRun ? 'color:#3b82f6;' : isDn ? 'color:#22c55e;' : (dark ? 'color:#64748b;' : 'color:#94a3b8;'));
              ic.textContent = isDn ? '\u2713' : isRun ? '\u25B6' : (idx + 1);
              card.appendChild(ic);

              var pt = document.createElement('div');
              var ptLong = job.prompt.length > 120;
              pt.style.cssText = 'flex:1;font-size:13px;line-height:1.4;word-break:break-word;white-space:pre-wrap;' +
                (ptLong ? 'max-height:3.6em;overflow:hidden;cursor:pointer;' : '');
              pt.textContent = job.prompt;
              if (ptLong) {
                pt.onclick = function() {
                  var open = this.style.maxHeight !== '3.6em';
                  this.style.maxHeight = open ? '3.6em' : 'none';
                  this.style.overflow = open ? 'hidden' : 'visible';
                };
              }
              card.appendChild(pt);

              var bw = document.createElement('div');
              bw.style.cssText = 'display:flex;gap:2px;flex-shrink:0;align-items:center;';
              if (job.status === 'pending' && !isThisPlanRunning) {
                if (idx > 0 && selPlan.jobs[idx - 1].status === 'pending') {
                  var ub = document.createElement('button');
                  ub.textContent = '\u25B2'; ub.title = 'Move up';
                  ub.style.cssText = 'border:none;background:none;cursor:pointer;font-size:10px;padding:2px;opacity:0.4;' + (dark ? 'color:#e2e8f0;' : '');
                  ub.onmouseenter = function() { this.style.opacity = '1'; };
                  ub.onmouseleave = function() { this.style.opacity = '0.4'; };
                  (function(pid, i) { ub.onclick = function() {
                    var p = getPlan(pid); if (!p) return;
                    var t = p.jobs[i]; p.jobs[i] = p.jobs[i-1]; p.jobs[i-1] = t;
                    savePlan(p); updateJobQueuePanel();
                  }; })(selPlan.id, idx);
                  bw.appendChild(ub);
                }
                if (idx < selPlan.jobs.length - 1 && selPlan.jobs[idx + 1].status === 'pending') {
                  var db = document.createElement('button');
                  db.textContent = '\u25BC'; db.title = 'Move down';
                  db.style.cssText = 'border:none;background:none;cursor:pointer;font-size:10px;padding:2px;opacity:0.4;' + (dark ? 'color:#e2e8f0;' : '');
                  db.onmouseenter = function() { this.style.opacity = '1'; };
                  db.onmouseleave = function() { this.style.opacity = '0.4'; };
                  (function(pid, i) { db.onclick = function() {
                    var p = getPlan(pid); if (!p) return;
                    var t = p.jobs[i]; p.jobs[i] = p.jobs[i+1]; p.jobs[i+1] = t;
                    savePlan(p); updateJobQueuePanel();
                  }; })(selPlan.id, idx);
                  bw.appendChild(db);
                }
              }
              if (job.status !== 'running') {
                var dl = document.createElement('button');
                dl.innerHTML = '&times;'; dl.title = 'Remove';
                dl.style.cssText = 'border:none;background:none;cursor:pointer;font-size:16px;padding:0 2px;opacity:0.3;' + (dark ? 'color:#e2e8f0;' : '');
                dl.onmouseenter = function() { this.style.opacity = '1'; this.style.color = '#ef4444'; };
                dl.onmouseleave = function() { this.style.opacity = '0.3'; this.style.color = dark ? '#e2e8f0' : ''; };
                (function(pid, i) { dl.onclick = function() {
                  var p = getPlan(pid); if (!p) return;
                  p.jobs.splice(i, 1); savePlan(p); updateJobQueuePanel();
                }; })(selPlan.id, idx);
                bw.appendChild(dl);
              }
              card.appendChild(bw);
              listWrap.appendChild(card);
            });
            panel.appendChild(listWrap);

            // Bottom controls
            var ctrls = document.createElement('div');
            ctrls.style.cssText = 'padding:12px 16px;border-top:1px solid ' + (dark ? '#334155' : '#e2e8f0') + ';display:flex;gap:8px;flex-shrink:0;';
            var hasPending = selPlan.jobs.some(function(j) { return j.status === 'pending'; });
            if (!isThisPlanRunning && hasPending) {
              var stBtn = document.createElement('button');
              stBtn.textContent = '\u25B6 Start';
              stBtn.style.cssText = 'flex:1;padding:8px;' + btnCss + 'background:#3b82f6;color:#fff;';
              (function(pid) { stBtn.onclick = function() { startPlan(pid); updateJobQueuePanel(); }; })(selPlan.id);
              ctrls.appendChild(stBtn);
            }
            if (isThisPlanRunning) {
              var paBtn = document.createElement('button');
              paBtn.textContent = '\u23F8 Pause';
              paBtn.style.cssText = 'flex:1;padding:8px;' + btnCss + 'background:#f59e0b;color:#fff;';
              paBtn.onclick = function() { pausePlan(); };
              ctrls.appendChild(paBtn);
            }
            if (selPlan.jobs.length > 0) {
              var rstBtn = document.createElement('button');
              rstBtn.textContent = 'Reset';
              rstBtn.title = 'Reset all jobs to pending';
              rstBtn.style.cssText = 'padding:8px 12px;' + btnCss + (dark ? 'background:#334155;color:#e2e8f0;' : 'background:#e2e8f0;color:#1e293b;');
              (function(pid) { rstBtn.onclick = function() {
                var p = getPlan(pid); if (!p) return;
                if (actId === pid) pausePlan();
                p.jobs.forEach(function(j) { j.status = 'pending'; });
                savePlan(p); updateJobQueuePanel();
              }; })(selPlan.id);
              ctrls.appendChild(rstBtn);
            }
            panel.appendChild(ctrls);
          }
          document.body.appendChild(panel);
        }

        var observer = new MutationObserver(function(mutations) {
          mutations.forEach(function(m) {
            if (m.attributeName === 'class') render();
          });
        });

        window.addEventListener('load', function() {
          applyFontSize();
          render();
          setupScrollObserver();
          observer.observe(document.documentElement, { attributes: true });
        });
      })();
    </script>

    <script>
      // Slash command palette — shows when typing / in textarea or via F1
      (function() {
        var COMMANDS = [
          { cmd: '/compact', desc: 'Clear history but keep a summary in context' },
          { cmd: '/clear', desc: 'Clear conversation history and free up context' },
          { cmd: '/commit', desc: 'Commit changes with a generated message' },
          { cmd: '/cost', desc: 'Show total cost and duration of current session' },
          { cmd: '/todos', desc: 'List current todo items' },
          { cmd: '/files', desc: 'List all files currently in context' },
          { cmd: '/init', desc: 'Initialize a new CLAUDE.md file' },
          { cmd: '/review', desc: 'Review a pull request' },
          { cmd: '/security-review', desc: 'Security review of pending changes on current branch' },
          { cmd: '/pr-comments', desc: 'Get comments from a GitHub PR' },
          { cmd: '/export', desc: 'Export conversation to file or clipboard' },
          { cmd: '/status', desc: 'Show version, model, account info' },
          { cmd: '/resume', desc: 'Resume a previous conversation' },
          { cmd: '/memory', desc: 'Edit Claude memory files' },
          { cmd: '/config', desc: 'Open config panel' },
          { cmd: '/hooks', desc: 'Manage hook configurations' },
          { cmd: '/agents', desc: 'Manage agent configurations' },
          { cmd: '/mcp', desc: 'Manage MCP servers' },
          { cmd: '/bashes', desc: 'List and manage background tasks' },
          { cmd: '/add-dir', desc: 'Add a new working directory' },
          { cmd: '/ide', desc: 'Manage IDE integrations and show status' },
          { cmd: '/install', desc: 'Install Claude Code native build' },
          { cmd: '/install-github-app', desc: 'Set up Claude GitHub Actions for a repo' },
          { cmd: '/upgrade', desc: 'Upgrade to Max for higher rate limits' },
          { cmd: '/feedback', desc: 'Submit feedback about Claude Code' },
          { cmd: '/privacy-settings', desc: 'View and update privacy settings' },
          { cmd: '/migrate-installer', desc: 'Migrate from npm to local installation' },
          { cmd: '/logout', desc: 'Sign out from your Anthropic account' },
          { cmd: '/help', desc: 'Show help and available commands' }
        ];

        function isDark() { return document.documentElement.classList.contains('dark'); }

        function sendToChat(text) {
          var ta = document.querySelector('textarea[placeholder="Type message..."]') ||
                   document.querySelector('textarea[placeholder="Processing..."]');
          if (!ta) return;
          var nativeSetter = Object.getOwnPropertyDescriptor(HTMLTextAreaElement.prototype, 'value').set;
          nativeSetter.call(ta, text);
          ta.dispatchEvent(new Event('input', { bubbles: true }));
          ta.focus();
          setTimeout(function() {
            var sendBtn = ta.closest('form') && ta.closest('form').querySelector('button[type="submit"]');
            if (sendBtn && !sendBtn.disabled) sendBtn.click();
          }, 50);
        }

        var palette = null;
        var selectedIdx = 0;
        var filteredCmds = COMMANDS;

        function showPalette(filterText) {
          hidePalette();
          var dark = isDark();
          var ta = document.querySelector('textarea[placeholder="Type message..."]') ||
                   document.querySelector('textarea[placeholder="Processing..."]');
          if (!ta) return;

          var filter = (filterText || '').toLowerCase().replace(/^\//, '');
          filteredCmds = COMMANDS.filter(function(c) {
            return c.cmd.toLowerCase().indexOf(filter) !== -1 || c.desc.toLowerCase().indexOf(filter) !== -1;
          });
          if (filteredCmds.length === 0) return;
          selectedIdx = 0;

          palette = document.createElement('div');
          palette.id = 'cmd-palette';
          palette.style.cssText = 'position:fixed;z-index:200000;max-height:300px;overflow-y:auto;border-radius:10px;padding:4px 0;font-family:ui-sans-serif,system-ui,sans-serif;font-size:13px;box-shadow:0 8px 24px rgba(0,0,0,0.2);' +
            (dark ? 'background:#1e293b;border:1px solid #334155;' : 'background:#fff;border:1px solid #e2e8f0;');

          // Position above the textarea
          var rect = ta.getBoundingClientRect();
          palette.style.bottom = (window.innerHeight - rect.top + 6) + 'px';
          palette.style.left = rect.left + 'px';
          palette.style.width = Math.min(380, rect.width) + 'px';

          filteredCmds.forEach(function(c, i) {
            var row = document.createElement('div');
            row.style.cssText = 'display:flex;align-items:baseline;gap:8px;padding:7px 12px;cursor:pointer;transition:background 0.1s;' +
              (i === selectedIdx ? (dark ? 'background:#334155;' : 'background:#f1f5f9;') : '');
            row.onmouseenter = function() {
              selectedIdx = i;
              highlightRow();
            };
            row.onclick = function() {
              hidePalette();
              sendToChat(c.cmd);
            };
            var cmdEl = document.createElement('span');
            cmdEl.style.cssText = 'font-weight:600;font-family:ui-monospace,monospace;font-size:12px;white-space:nowrap;' +
              (dark ? 'color:#93c5fd;' : 'color:#2563eb;');
            cmdEl.textContent = c.cmd;
            row.appendChild(cmdEl);
            var descEl = document.createElement('span');
            descEl.style.cssText = 'font-size:11px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;' +
              (dark ? 'color:#94a3b8;' : 'color:#64748b;');
            descEl.textContent = c.desc;
            row.appendChild(descEl);
            palette.appendChild(row);
          });

          document.body.appendChild(palette);
        }

        function highlightRow() {
          if (!palette) return;
          var rows = palette.children;
          var dark = isDark();
          for (var i = 0; i < rows.length; i++) {
            rows[i].style.background = i === selectedIdx ? (dark ? '#334155' : '#f1f5f9') : 'transparent';
          }
        }

        function hidePalette() {
          if (palette) { palette.remove(); palette = null; }
        }

        // Watch textarea for / typing
        document.addEventListener('input', function(e) {
          var ta = e.target;
          if (!ta || ta.tagName !== 'TEXTAREA') return;
          var val = ta.value || '';
          if (val.startsWith('/') && val.indexOf('\n') === -1) {
            showPalette(val);
          } else {
            hidePalette();
          }
        }, true);

        // Keyboard navigation in palette
        document.addEventListener('keydown', function(e) {
          if (!palette) {
            // F1 to open command palette
            if (e.key === 'F1') {
              e.preventDefault();
              var ta = document.querySelector('textarea[placeholder="Type message..."]');
              if (ta) {
                var nativeSetter = Object.getOwnPropertyDescriptor(HTMLTextAreaElement.prototype, 'value').set;
                nativeSetter.call(ta, '/');
                ta.dispatchEvent(new Event('input', { bubbles: true }));
                ta.focus();
                showPalette('/');
              }
            }
            return;
          }
          if (e.key === 'ArrowDown') {
            e.preventDefault();
            selectedIdx = Math.min(selectedIdx + 1, filteredCmds.length - 1);
            highlightRow();
            // Scroll into view
            var rows = palette.children;
            if (rows[selectedIdx]) rows[selectedIdx].scrollIntoView({ block: 'nearest' });
          } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            selectedIdx = Math.max(selectedIdx - 1, 0);
            highlightRow();
            var rows2 = palette.children;
            if (rows2[selectedIdx]) rows2[selectedIdx].scrollIntoView({ block: 'nearest' });
          } else if (e.key === 'Enter' && filteredCmds[selectedIdx]) {
            e.preventDefault();
            var cmd = filteredCmds[selectedIdx].cmd;
            hidePalette();
            sendToChat(cmd);
          } else if (e.key === 'Escape') {
            hidePalette();
          }
        }, true);

        // Close on click outside
        document.addEventListener('click', function(e) {
          if (palette && !palette.contains(e.target)) {
            var ta = document.querySelector('textarea');
            if (e.target !== ta) hidePalette();
          }
        }, true);
      })();
    </script>

    <!-- Auto-approve permissions -->
    <script>
      (function() {
        var autoApproveObserver = new MutationObserver(function(mutations) {
          // Look for the Permission Required dialog
          var headings = document.querySelectorAll('h3');
          for (var i = 0; i < headings.length; i++) {
            if (headings[i].textContent === 'Permission Required') {
              var container = headings[i].closest('.flex-shrink-0');
              if (!container) continue;
              var buttons = container.querySelectorAll('button');
              // Find the "Yes, and don't ask again" button (second button, contains "don't ask again")
              for (var j = 0; j < buttons.length; j++) {
                var txt = buttons[j].textContent || '';
                if (txt.indexOf("don't ask again") !== -1 || txt.indexOf("don\u2019t ask again") !== -1) {
                  console.log('[Auto-approve] Clicking: ' + txt);
                  buttons[j].click();
                  return;
                }
              }
              // Fallback: click first button (Yes)
              if (buttons.length > 0) {
                console.log('[Auto-approve] Clicking Yes (fallback)');
                buttons[0].click();
                return;
              }
            }
          }
          // Also handle plan mode approval dialogs
          var planBtns = document.querySelectorAll('button');
          for (var k = 0; k < planBtns.length; k++) {
            var ptxt = planBtns[k].textContent || '';
            if (ptxt.indexOf('Yes, and auto-accept edits') !== -1) {
              var planContainer = planBtns[k].closest('.flex-shrink-0');
              if (planContainer && planContainer.querySelector('p')?.textContent?.indexOf('Choose how to proceed') !== -1) {
                console.log('[Auto-approve] Clicking: ' + ptxt);
                planBtns[k].click();
                return;
              }
            }
          }
        });

        window.addEventListener('load', function() {
          autoApproveObserver.observe(document.body, {
            childList: true,
            subtree: true
          });
        });
      })();
    </script>

    <!-- Session restore per tab -->
    <script>
      (function() {
        var SESSION_KEY = 'claude-webui-tab-session-' + window.location.pathname;
        var TAB_IDENTITY_KEY = 'claude-webui-tab-identity';
        var restoreSessionId = null;

        // Full UUID is 36 chars (with dashes) or 32 chars (without)
        function isFullUUID(id) { return id && id.length >= 32; }

        // Detect new tab vs refresh: sessionStorage persists across refreshes
        // but is empty in brand-new tabs. Auto-restore session on refresh.
        var isNewTab = !sessionStorage.getItem(TAB_IDENTITY_KEY);
        if (isNewTab) {
          sessionStorage.setItem(TAB_IDENTITY_KEY, Date.now().toString());
        } else {
          // This is a refresh — auto-restore only if we have a FULL UUID
          var saved = getSavedSession();
          if (saved && saved.sessionId && isFullUUID(saved.sessionId)) {
            restoreSessionId = saved.sessionId;
            window.__currentFullSessionId = saved.sessionId;
            console.log('[Session Restore] Auto-restoring session on refresh:', saved.sessionId);
          }
        }
        function getSavedSession() {
          try { return JSON.parse(localStorage.getItem(SESSION_KEY)); }
          catch { return null; }
        }
        function saveSession(sessionId) {
          // Only save full UUIDs — never overwrite a full UUID with a truncated one
          if (!isFullUUID(sessionId)) {
            var existing = getSavedSession();
            if (existing && isFullUUID(existing.sessionId)) return; // don't overwrite
          }
          localStorage.setItem(SESSION_KEY, JSON.stringify({
            sessionId: sessionId,
            url: window.location.href,
            timestamp: Date.now()
          }));
        }

        function isDark() { return document.documentElement.classList.contains('dark'); }

        // Watch DOM for session ID and save it (MutationObserver + polling fallback)
        var lastSeenSession = null;
        function watchSessionId() {
          var spans = document.querySelectorAll('span');
          for (var i = 0; i < spans.length; i++) {
            var text = spans[i].textContent || '';
            var match = text.match(/Session:\s*([a-f0-9]{8,})/);
            if (match) {
              var domId = match[1];
              // Prefer full UUID from __currentFullSessionId if it matches the short ID
              var fullId = window.__currentFullSessionId;
              var bestId = (fullId && fullId.indexOf(domId) === 0) ? fullId : domId;
              if (bestId !== lastSeenSession) {
                lastSeenSession = bestId;
                saveSession(bestId);
                // Update browser tab title with session ID (and custom name if set)
                var shortId = bestId.substring(0, 8);
                try {
                  var titles = JSON.parse(localStorage.getItem('claude-webui-session-titles') || '{}');
                  var customName = titles[bestId] || titles[shortId] || '';
                  document.title = (customName ? customName + ' ' : '') + '[' + shortId + '] Claude Code';
                } catch(e2) {
                  document.title = '[' + shortId + '] Claude Code';
                }
                console.log('[Session Restore] Saved session:', bestId);
              }
            }
          }
        }
        var sessionObserver = new MutationObserver(function() { watchSessionId(); });
        window.addEventListener('load', function() {
          sessionObserver.observe(document.body, { childList: true, subtree: true, characterData: true });
          watchSessionId();
        });
        setInterval(watchSessionId, 3000);

        // Detect when React navigates back from history view to a blank conversation.
        // If we have a saved session, redirect with ?sessionId= so React loads it.
        var _lastUrl = window.location.href;
        var _wasOnHistoryView = window.location.search.indexOf('view=history') !== -1;
        setInterval(function() {
          var currentUrl = window.location.href;
          var onHistoryNow = window.location.search.indexOf('view=history') !== -1;
          if (onHistoryNow) { _wasOnHistoryView = true; }
          if (currentUrl !== _lastUrl) {
            _lastUrl = currentUrl;
            var params = new URLSearchParams(window.location.search);
            // Just left history view and landed on blank conversation (no sessionId)
            if (_wasOnHistoryView && !onHistoryNow && !params.get('sessionId')) {
              _wasOnHistoryView = false;
              var saved = getSavedSession();
              if (saved && saved.sessionId && isFullUUID(saved.sessionId)) {
                console.log('[Session Restore] Back from history, redirecting to session:', saved.sessionId);
                params.set('sessionId', saved.sessionId);
                window.location.replace(window.location.pathname + '?' + params.toString());
                return;
              }
            }
          }
        }, 300);

        // Intercept outgoing /api/chat to inject saved sessionId
        var _origFetch = window.fetch;
        window.fetch = function() {
          var args = arguments;
          var url = (args[0] && typeof args[0] === 'string') ? args[0] : (args[0] && args[0].url ? args[0].url : '');
          var opts = args[1] || {};

          if (url.indexOf('/api/chat') !== -1 && opts.method && opts.method.toUpperCase() === 'POST' && opts.body) {
            try {
              var bodyObj = JSON.parse(opts.body);
              var bodyChanged = false;
              // Inject saved sessionId if restoring (override whatever React set)
              if (restoreSessionId) {
                console.log('[Session Restore] Overriding sessionId from', bodyObj.sessionId, 'to', restoreSessionId);
                bodyObj.sessionId = restoreSessionId;
                restoreSessionId = null;
                var banner = document.getElementById('session-restore-banner');
                if (banner) banner.remove();
                bodyChanged = true;
              }
              if (bodyChanged) {
                args = [args[0], Object.assign({}, opts, { body: JSON.stringify(bodyObj) })];
              }
              // Capture sessionId from outgoing requests to save it
              if (bodyObj.sessionId && bodyObj.sessionId !== lastSeenSession) {
                lastSeenSession = bodyObj.sessionId;
                window.__currentFullSessionId = bodyObj.sessionId; // Store full ID for fork button
                saveSession(bodyObj.sessionId);
                console.log('[Session Restore] Saved session:', bodyObj.sessionId);
              }
            } catch(e) {}
          }

          // Intercept /histories responses to sort by most recent activity
          if (url.indexOf('/histories') !== -1) {
            return _origFetch.apply(this, args).then(function(response) {
              var cloned = response.clone();
              return cloned.json().then(function(data) {
                if (data && Array.isArray(data.conversations)) {
                  data.conversations.sort(function(a, b) {
                    var ta = a.lastTime || a.startTime || '';
                    var tb = b.lastTime || b.startTime || '';
                    return ta > tb ? -1 : ta < tb ? 1 : 0;
                  });
                  return new Response(JSON.stringify(data), {
                    status: response.status,
                    statusText: response.statusText,
                    headers: response.headers
                  });
                }
                return response;
              }).catch(function() { return response; });
            });
          }

          return _origFetch.apply(this, args);
        };

        // Show restore banner on load — DISABLED: user can pick sessions from top-right menu
        function showRestoreBanner() {
          return; // Restore feature disabled — sessions accessible via top-right session picker

          var dark = isDark();

          var banner = document.createElement('div');
          banner.id = 'session-restore-banner';
          banner.style.cssText = 'position:fixed;bottom:80px;left:50%;transform:translateX(-50%);z-index:100000;display:flex;align-items:center;gap:10px;padding:10px 16px;border-radius:10px;font-family:ui-sans-serif,system-ui,sans-serif;font-size:13px;box-shadow:0 4px 16px rgba(0,0,0,0.15);transition:opacity 0.3s;' +
            (dark ? 'background:#1e293b;color:#e2e8f0;border:1px solid #334155;' : 'background:#fff;color:#1e293b;border:1px solid #e2e8f0;');

          var text = document.createElement('span');
          text.textContent = 'Restore last session?';
          text.style.cssText = 'font-weight:500;';
          banner.appendChild(text);

          var sessionLabel = document.createElement('span');
          sessionLabel.textContent = saved.sessionId.substring(0, 8) + '...';
          sessionLabel.style.cssText = 'font-family:ui-monospace,monospace;font-size:11px;padding:2px 6px;border-radius:4px;' +
            (dark ? 'background:#334155;color:#94a3b8;' : 'background:#f1f5f9;color:#64748b;');
          banner.appendChild(sessionLabel);

          var restoreBtn = document.createElement('button');
          restoreBtn.textContent = 'Restore';
          restoreBtn.style.cssText = 'padding:5px 14px;border-radius:6px;border:none;cursor:pointer;font-size:12px;font-weight:600;transition:background 0.15s;background:#3b82f6;color:#fff;';
          restoreBtn.onmouseenter = function() { restoreBtn.style.background = '#2563eb'; };
          restoreBtn.onmouseleave = function() { restoreBtn.style.background = '#3b82f6'; };
          restoreBtn.onclick = function() {
            restoreSessionId = saved.sessionId;
            banner.style.opacity = '0';
            setTimeout(function() { banner.remove(); }, 300);
            // Show persistent badge with restored session ID
            var badge = document.createElement('div');
            badge.id = 'session-restored-badge';
            badge.style.cssText = 'position:fixed;top:8px;left:50%;transform:translateX(-50%);z-index:100000;display:flex;align-items:center;gap:8px;padding:6px 12px;border-radius:8px;font-family:ui-sans-serif,system-ui,sans-serif;font-size:12px;' +
              (dark ? 'background:#1e3a5f;color:#93c5fd;border:1px solid #2563eb;' : 'background:#eff6ff;color:#1d4ed8;border:1px solid #93c5fd;');
            var badgeIcon = document.createElement('span');
            badgeIcon.textContent = '\u2705';
            badgeIcon.style.cssText = 'font-size:14px;';
            badge.appendChild(badgeIcon);
            var badgeText = document.createElement('span');
            badgeText.innerHTML = 'Restored: <b style="font-family:ui-monospace,monospace;letter-spacing:0.02em;">' + saved.sessionId + '</b>';
            badge.appendChild(badgeText);
            var badgeHint = document.createElement('span');
            badgeHint.textContent = '(compare with Session ID below)';
            badgeHint.style.cssText = 'font-size:10px;opacity:0.7;';
            badge.appendChild(badgeHint);
            var badgeClose = document.createElement('button');
            badgeClose.innerHTML = '&times;';
            badgeClose.style.cssText = 'border:none;background:none;cursor:pointer;font-size:14px;padding:0 2px;' +
              (dark ? 'color:#93c5fd;' : 'color:#1d4ed8;');
            badgeClose.onclick = function() { badge.remove(); };
            badge.appendChild(badgeClose);
            document.body.appendChild(badge);
            // Also show the toast
            var t = document.createElement('div');
            t.textContent = 'Chat looks empty but Claude has full context. Type "continue" to pick up where you left off.';
            t.style.cssText = 'position:fixed;bottom:20px;left:50%;transform:translateX(-50%);padding:10px 20px;border-radius:8px;font-size:13px;z-index:100000;transition:opacity 0.5s;pointer-events:none;max-width:500px;text-align:center;line-height:1.4;' +
              (dark ? 'background:#334155;color:#e2e8f0;' : 'background:#1e293b;color:#f1f5f9;');
            document.body.appendChild(t);
            setTimeout(function() { t.style.opacity = '0'; }, 4000);
            setTimeout(function() { t.remove(); }, 4500);
          };
          banner.appendChild(restoreBtn);

          var dismissBtn = document.createElement('button');
          dismissBtn.innerHTML = '&times;';
          dismissBtn.style.cssText = 'border:none;background:none;cursor:pointer;font-size:16px;padding:0 4px;' +
            (dark ? 'color:#64748b;' : 'color:#94a3b8;');
          dismissBtn.onclick = function() {
            banner.style.opacity = '0';
            setTimeout(function() { banner.remove(); }, 300);
          };
          banner.appendChild(dismissBtn);

          document.body.appendChild(banner);
        }

        window.addEventListener('load', function() {
          setTimeout(showRestoreBanner, 1000);
        });
      })();
    </script>

    <!-- Thinking progress indicator -->
    <script>
      (function() {
        var thinkingStartTime = null;
        var thinkingTimer = null;
        var streamBytes = 0;
        var streamTokens = 0;
        var lastChunkTime = null;
        var lastHeartbeat = null;
        var activeTool = null;
        var overlayEl = null;
        var thinkingTokens = 0;

        function formatElapsed(ms) {
          var secs = Math.floor(ms / 1000);
          if (secs < 60) return secs + 's';
          var mins = Math.floor(secs / 60);
          secs = secs % 60;
          return mins + 'm ' + (secs < 10 ? '0' : '') + secs + 's';
        }

        function formatTokens(n) {
          if (n >= 1000) return (n / 1000).toFixed(1) + 'k';
          return String(n);
        }

        function createOverlay() {
          if (overlayEl) return;
          overlayEl = document.createElement('div');
          overlayEl.id = 'thinking-progress';
          var dark = document.documentElement.classList.contains('dark');
          overlayEl.style.cssText = 'font-family:ui-monospace,monospace;font-size:11px;padding:3px 8px;border-radius:6px;display:inline-flex;align-items:center;gap:8px;margin-top:2px;flex-wrap:wrap;max-width:400px;' +
            (dark ? 'color:#94a3b8;background:rgba(30,41,59,0.7);' : 'color:#64748b;background:rgba(241,245,249,0.8);');
          overlayEl.innerHTML =
            '<span class="elapsed">0s</span>' +
            '<span class="dot" style="width:4px;height:4px;border-radius:50%;background:currentColor;opacity:0.5;animation:tpulse 1.5s infinite;"></span>' +
            '<span class="tokens" style="opacity:0.7;"></span>' +
            '<span class="tool-info" style="opacity:0.7;font-size:10px;width:100%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;"></span>';
          if (!document.getElementById('thinking-progress-style')) {
            var style = document.createElement('style');
            style.id = 'thinking-progress-style';
            style.textContent = '@keyframes tpulse{0%,100%{opacity:0.3}50%{opacity:1}}';
            document.head.appendChild(style);
          }
        }

        function updateOverlay() {
          if (!overlayEl || !thinkingStartTime) return;
          var elapsed = Date.now() - thinkingStartTime;
          var elSpan = overlayEl.querySelector('.elapsed');
          var tokSpan = overlayEl.querySelector('.tokens');
          var toolSpan = overlayEl.querySelector('.tool-info');
          if (elSpan) elSpan.textContent = formatElapsed(elapsed);
          if (tokSpan) {
            var parts = [];
            if (streamTokens > 0) parts.push('\u2193 ' + formatTokens(streamTokens) + ' tokens');
            if (thinkingTokens > 0) parts.push('thought ' + formatTokens(thinkingTokens));
            tokSpan.textContent = parts.join(' \u00B7 ');
          }
          if (toolSpan) toolSpan.textContent = activeTool ? '\u25B8 ' + activeTool : '';
        }

        function attachOverlay() {
          var spans = document.querySelectorAll('span.animate-pulse');
          for (var i = 0; i < spans.length; i++) {
            if (spans[i].textContent === 'Thinking...') {
              var parent = spans[i].parentElement;
              if (parent && !parent.querySelector('#thinking-progress')) {
                createOverlay();
                parent.appendChild(overlayEl);
              }
              return true;
            }
          }
          return false;
        }

        function startThinking() {
          if (thinkingStartTime) return;
          thinkingStartTime = Date.now();
          streamBytes = 0;
          streamTokens = 0;
          thinkingTokens = 0;
          lastChunkTime = null;
          activeTool = null;
          thinkingTimer = setInterval(function() {
            if (!attachOverlay()) {
              stopThinking();
              return;
            }
            updateOverlay();
          }, 500);
        }

        function stopThinking() {
          thinkingStartTime = null;
          streamBytes = 0;
          streamTokens = 0;
          thinkingTokens = 0;
          activeTool = null;
          lastHeartbeat = null;
          if (thinkingTimer) { clearInterval(thinkingTimer); thinkingTimer = null; }
          if (overlayEl && overlayEl.parentNode) { overlayEl.remove(); }
          overlayEl = null;
        }

        var thinkingObserver = new MutationObserver(function() {
          var found = document.querySelector('span.animate-pulse');
          if (found && found.textContent === 'Thinking...') {
            startThinking();
          } else if (thinkingStartTime) {
            stopThinking();
          }
        });
        window.addEventListener('load', function() {
          thinkingObserver.observe(document.body, { childList: true, subtree: true });
        });

        window.__thinkingProgress = {
          onChunk: function(byteLen) {
            if (thinkingStartTime) {
              streamBytes += (byteLen || 0);
              lastChunkTime = Date.now();
            }
          },
          onHeartbeat: function() {
            lastHeartbeat = Date.now();
          },
          onToolUse: function(toolLabel) {
            activeTool = toolLabel;
          },
          onTokens: function(inputTokens, outputTokens) {
            // From SDK usage data
            if (inputTokens) streamTokens = inputTokens;
            if (outputTokens && outputTokens > streamTokens) streamTokens = outputTokens;
          },
          addStreamTokens: function(count) {
            streamTokens += count;
          },
          addThinkingTokens: function(count) {
            thinkingTokens += count;
          }
        };
      })();
    </script>

    <!-- Message Queue (type while processing) -->
    <script>
      (function() {
        var messageQueue = [];
        var isProcessing = false;
        var queueBadge = null;

        function isDark() { return document.documentElement.classList.contains('dark'); }

        // Keep textarea enabled even when React disables it
        var textareaObserver = new MutationObserver(function(mutations) {
          for (var i = 0; i < mutations.length; i++) {
            var m = mutations[i];
            if (m.type === 'attributes' && m.attributeName === 'disabled') {
              var ta = m.target;
              if (ta.tagName === 'TEXTAREA' && ta.disabled) {
                isProcessing = true;
                ta.disabled = false;
                ta.placeholder = messageQueue.length > 0
                  ? 'Queued: ' + messageQueue.length + ' message(s)... type another or press Enter'
                  : 'Type to queue a message...';
              }
            }
          }
        });

        // Also watch for new textareas being added (React re-renders)
        var bodyObserver = new MutationObserver(function() {
          var textareas = document.querySelectorAll('textarea[disabled]');
          for (var i = 0; i < textareas.length; i++) {
            var ta = textareas[i];
            // Only target the chat input textarea (has the specific classes)
            if (ta.className.indexOf('rounded-xl') !== -1) {
              isProcessing = true;
              ta.disabled = false;
              ta.placeholder = messageQueue.length > 0
                ? 'Queued: ' + messageQueue.length + ' message(s)... type another or press Enter'
                : 'Type to queue a message...';
              // Observe attribute changes on this textarea
              textareaObserver.observe(ta, { attributes: true, attributeFilter: ['disabled'] });
            }
          }
        });

        window.addEventListener('load', function() {
          bodyObserver.observe(document.body, { childList: true, subtree: true });
        });

        function escapeHtml(s) {
          var d = document.createElement('div');
          d.textContent = s;
          return d.innerHTML;
        }

        function truncate(s, len) {
          return s.length > len ? s.substring(0, len) + '...' : s;
        }

        function updateQueueBadge() {
          if (messageQueue.length === 0) {
            if (queueBadge) { queueBadge.remove(); queueBadge = null; }
            return;
          }
          if (!queueBadge) {
            queueBadge = document.createElement('div');
            queueBadge.id = 'msg-queue-badge';
            document.body.appendChild(queueBadge);
          }
          var dark = isDark();
          queueBadge.style.cssText = 'position:fixed;bottom:62px;right:20px;z-index:100000;padding:6px 12px;border-radius:10px;font-family:ui-sans-serif,system-ui,sans-serif;font-size:11px;font-weight:500;max-width:340px;' +
            (dark ? 'background:#1e3a5f;color:#93c5fd;border:1px solid #2563eb;' : 'background:#eff6ff;color:#1d4ed8;border:1px solid #93c5fd;');

          var html = '<div style="display:flex;align-items:center;gap:6px;margin-bottom:' + (messageQueue.length > 0 ? '6' : '0') + 'px;">';
          html += '<span style="font-size:13px;">\uD83D\uDCE8</span> <span style="font-weight:600;">' + messageQueue.length + ' queued</span>';
          html += '</div>';

          for (var i = 0; i < messageQueue.length; i++) {
            var msg = messageQueue[i];
            var num = i + 1;
            html += '<div style="display:flex;align-items:flex-start;gap:6px;padding:3px 0;' + (i > 0 ? 'border-top:1px solid ' + (dark ? 'rgba(59,130,246,0.2)' : 'rgba(29,78,216,0.1)') + ';' : '') + '">';
            html += '<span style="flex-shrink:0;font-size:10px;opacity:0.5;margin-top:1px;">' + num + '.</span>';
            html += '<span style="font-family:ui-monospace,monospace;font-size:10px;opacity:0.8;line-height:1.4;word-break:break-word;">' + escapeHtml(truncate(msg, 80)) + '</span>';
            html += '</div>';
          }

          queueBadge.innerHTML = html;
        }

        // Intercept Enter key on textarea during processing to queue
        document.addEventListener('keydown', function(e) {
          if (e.key !== 'Enter' || e.shiftKey) return;
          if (!isProcessing) return;

          var ta = document.querySelector('textarea.rounded-xl') ||
                   document.querySelector('textarea');
          if (!ta || document.activeElement !== ta) return;
          var val = ta.value.trim();
          if (!val) return;

          e.preventDefault();
          e.stopPropagation();
          e.stopImmediatePropagation();

          messageQueue.push(val);
          ta.value = '';
          // Fire input event so React updates its state
          ta.dispatchEvent(new Event('input', { bubbles: true }));
          ta.placeholder = 'Queued: ' + messageQueue.length + ' message(s)... type another or press Enter';
          updateQueueBadge();
          console.log('[MsgQueue] Queued message:', val, 'Total:', messageQueue.length);
        }, true); // capture phase to beat React

        // When processing ends, send queued messages
        function onProcessingDone() {
          isProcessing = false;
          if (messageQueue.length === 0) return;

          // Small delay for React to reset its state
          setTimeout(function() {
            var nextMsg = messageQueue.shift();
            updateQueueBadge();
            if (!nextMsg) return;

            console.log('[MsgQueue] Sending queued message:', nextMsg);

            // Set the textarea value and trigger React's submit
            var ta = document.querySelector('textarea.rounded-xl') ||
                     document.querySelector('textarea');
            if (ta) {
              // Set value through native setter to trigger React's onChange
              var nativeSetter = Object.getOwnPropertyDescriptor(
                window.HTMLTextAreaElement.prototype, 'value'
              ).set;
              nativeSetter.call(ta, nextMsg);
              ta.dispatchEvent(new Event('input', { bubbles: true }));

              // Submit the form
              setTimeout(function() {
                var form = ta.closest('form');
                if (form) {
                  form.dispatchEvent(new Event('submit', { bubbles: true, cancelable: true }));
                }
              }, 100);
            }
          }, 500);
        }

        // Expose for stream interceptor
        window.__messageQueue = {
          onStreamDone: onProcessingDone
        };
      })();
    </script>

    <!-- Floating Todo Panel -->
    <script>
      (function() {
        var panelEl = null;
        var currentTodos = [];
        var panelCollapsed = false;
        var POS_KEY = 'claude-webui-todo-pos';
        var isDragging = false;
        var dragOffset = { x: 0, y: 0 };

        function isDark() { return document.documentElement.classList.contains('dark'); }

        function getPos() {
          try { return JSON.parse(localStorage.getItem(POS_KEY)) || { top: 380, left: 12 }; }
          catch { return { top: 380, left: 12 }; }
        }
        function savePos(top, left) {
          localStorage.setItem(POS_KEY, JSON.stringify({ top: top, left: left }));
        }

        var statusIcons = {
          'pending': '\u23F3',       // hourglass
          'in_progress': '\uD83D\uDD04', // cycle
          'completed': '\u2705'      // check
        };

        function createPanel() {
          if (panelEl) return;
          var dark = isDark();
          var pos = getPos();
          panelEl = document.createElement('div');
          panelEl.id = 'todo-float-panel';
          panelEl.style.cssText = 'position:fixed;top:' + pos.top + 'px;left:' + pos.left + 'px;z-index:99999;width:260px;border-radius:10px;font-family:ui-sans-serif,system-ui,sans-serif;font-size:12px;box-shadow:0 4px 20px rgba(0,0,0,0.15);' +
            (dark ? 'background:#1e293b;color:#e2e8f0;border:1px solid #334155;' : 'background:#fff;color:#1e293b;border:1px solid #e2e8f0;');
          document.body.appendChild(panelEl);
          renderPanel();
        }

        function renderPanel() {
          if (!panelEl) return;
          var dark = isDark();
          var completed = currentTodos.filter(function(t) { return t.status === 'completed'; }).length;
          var total = currentTodos.length;
          var pct = total > 0 ? Math.round((completed / total) * 100) : 0;

          var html = '<div style="padding:8px 12px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid ' + (dark ? '#334155' : '#e2e8f0') + ';cursor:grab;user-select:none;" id="todo-panel-header">';
          html += '<span style="font-weight:600;font-size:12px;display:flex;align-items:center;gap:6px;pointer-events:none;">\uD83D\uDCCB Tasks <span style="font-weight:400;opacity:0.6;">' + completed + '/' + total + '</span></span>';
          html += '<span style="font-size:10px;opacity:0.5;pointer-events:none;">' + (panelCollapsed ? '\u25B6' : '\u25BC') + '</span>';
          html += '</div>';

          if (!panelCollapsed) {
            // Progress bar
            html += '<div style="padding:4px 12px 6px;">';
            html += '<div style="height:3px;border-radius:2px;overflow:hidden;' + (dark ? 'background:#334155;' : 'background:#e2e8f0;') + '">';
            html += '<div style="height:100%;border-radius:2px;transition:width 0.4s;background:#22c55e;width:' + pct + '%;"></div>';
            html += '</div></div>';

            // Todo items
            html += '<div style="padding:0 12px 8px;max-height:300px;overflow-y:auto;">';
            for (var i = 0; i < currentTodos.length; i++) {
              var t = currentTodos[i];
              var icon = statusIcons[t.status] || '\u2B55';
              var textStyle = t.status === 'completed' ? 'text-decoration:line-through;opacity:0.5;' : '';
              var activeStyle = t.status === 'in_progress' ? 'font-weight:500;' : '';

              html += '<div style="display:flex;align-items:flex-start;gap:6px;padding:4px 0;' + activeStyle + '">';
              html += '<span style="flex-shrink:0;font-size:11px;margin-top:1px;">' + icon + '</span>';
              html += '<div style="flex:1;min-width:0;">';
              html += '<div style="' + textStyle + 'line-height:1.4;">' + escapeHtml(t.content || '') + '</div>';
              if (t.status === 'in_progress' && t.activeForm) {
                html += '<div style="font-size:10px;font-style:italic;opacity:0.6;margin-top:1px;">' + escapeHtml(t.activeForm) + '</div>';
              }
              html += '</div></div>';
            }
            html += '</div>';
          }

          panelEl.innerHTML = html;

          // Drag + collapse on header
          var header = panelEl.querySelector('#todo-panel-header');
          if (header) {
            header.addEventListener('mousedown', function(e) {
              isDragging = true;
              dragOffset.x = e.clientX - panelEl.offsetLeft;
              dragOffset.y = e.clientY - panelEl.offsetTop;
              dragOffset.startX = e.clientX;
              dragOffset.startY = e.clientY;
              header.style.cursor = 'grabbing';
              e.preventDefault();
            });
          }
        }

        // Global drag handlers
        document.addEventListener('mousemove', function(e) {
          if (!isDragging || !panelEl) return;
          var newLeft = e.clientX - dragOffset.x;
          var newTop = e.clientY - dragOffset.y;
          newLeft = Math.max(0, Math.min(window.innerWidth - 100, newLeft));
          newTop = Math.max(0, Math.min(window.innerHeight - 40, newTop));
          panelEl.style.left = newLeft + 'px';
          panelEl.style.top = newTop + 'px';
        });
        document.addEventListener('mouseup', function(e) {
          if (!isDragging || !panelEl) return;
          isDragging = false;
          var header = panelEl.querySelector('#todo-panel-header');
          if (header) header.style.cursor = 'grab';
          savePos(parseInt(panelEl.style.top), parseInt(panelEl.style.left));
          // If mouse barely moved, treat as click (toggle collapse)
          var dx = Math.abs(e.clientX - dragOffset.startX);
          var dy = Math.abs(e.clientY - dragOffset.startY);
          if (dx < 5 && dy < 5) {
            panelCollapsed = !panelCollapsed;
            renderPanel();
          }
        });

        function escapeHtml(s) {
          var div = document.createElement('div');
          div.textContent = s;
          return div.innerHTML;
        }

        function updateTodos(todos) {
          if (!todos || !Array.isArray(todos) || todos.length === 0) return;
          currentTodos = todos;
          createPanel();
          renderPanel();
        }

        function removePanel() {
          if (panelEl) { panelEl.remove(); panelEl = null; }
          currentTodos = [];
        }

        // Expose for stream interceptor
        window.__todoPanel = {
          update: updateTodos,
          remove: removePanel
        };
      })();
    </script>

    <!-- Process Manager Panel -->
    <script>
      (function() {
        var panelEl = null;
        var collapsed = true;
        var pollTimer = null;
        var lastData = null;
        var toggleBtn = null;

        function isDark() { return document.documentElement.classList.contains('dark'); }

        function escapeHtml(s) {
          var div = document.createElement('div');
          div.textContent = s;
          return div.innerHTML;
        }

        function shortenCmd(cmd) {
          if (!cmd) return '';
          // Remove common prefixes, keep meaningful part
          cmd = cmd.replace(/^"?[A-Z]:\\.*?\\(node|dotnet|claude|git|python|npm|bash)\.exe"?\s*/i, '');
          cmd = cmd.replace(/^(cmd\.exe\s+\/[cC]\s+)/i, '');
          if (cmd.length > 60) cmd = cmd.substring(0, 57) + '...';
          return cmd;
        }

        function createToggleButton() {
          if (toggleBtn) return;
          toggleBtn = document.createElement('button');
          toggleBtn.id = 'proc-toggle-btn';
          var dark = isDark();
          toggleBtn.style.cssText = 'position:fixed;bottom:12px;left:12px;z-index:99998;width:32px;height:32px;border-radius:8px;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:14px;transition:all 0.2s;opacity:0.8;' +
            (dark ? 'background:#1e293b;color:#94a3b8;border:1px solid #475569;' : 'background:#f1f5f9;color:#64748b;border:1px solid #cbd5e1;');
          toggleBtn.textContent = '\u2699'; // gear icon
          toggleBtn.title = 'Process Manager';
          toggleBtn.onmouseenter = function() { toggleBtn.style.opacity = '1'; };
          toggleBtn.onmouseleave = function() { toggleBtn.style.opacity = '0.6'; };
          toggleBtn.onclick = function() {
            collapsed = !collapsed;
            if (collapsed) {
              if (panelEl) { panelEl.style.display = 'none'; }
              stopPolling();
            } else {
              createPanel();
              panelEl.style.display = '';
              fetchProcesses();
              startPolling();
            }
          };
          document.body.appendChild(toggleBtn);
        }

        function createPanel() {
          if (panelEl) return;
          var dark = isDark();
          panelEl = document.createElement('div');
          panelEl.id = 'proc-manager-panel';
          panelEl.style.cssText = 'position:fixed;bottom:50px;left:12px;z-index:99998;width:320px;max-height:400px;border-radius:10px;font-family:ui-sans-serif,system-ui,sans-serif;font-size:12px;box-shadow:0 4px 20px rgba(0,0,0,0.18);overflow:hidden;display:none;' +
            (dark ? 'background:#1e293b;color:#e2e8f0;border:1px solid #334155;' : 'background:#fff;color:#1e293b;border:1px solid #e2e8f0;');
          document.body.appendChild(panelEl);
        }

        function renderPanel(data) {
          if (!panelEl) return;
          var dark = isDark();
          var children = (data && data.children) || [];
          // Filter out powershell/conhost noise
          children = children.filter(function(p) {
            var n = (p.name || '').toLowerCase();
            return n !== 'conhost.exe' && n !== 'powershell.exe' && n !== 'cmd.exe';
          });

          var html = '<div style="padding:8px 12px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid ' + (dark ? '#334155' : '#e2e8f0') + ';">';
          html += '<span style="font-weight:600;font-size:12px;display:flex;align-items:center;gap:6px;">\u2699 Processes <span style="font-weight:400;opacity:0.5;font-size:11px;">' + children.length + '</span></span>';
          html += '<span style="font-size:10px;opacity:0.4;">PID ' + (data ? data.pid : '?') + '</span>';
          html += '</div>';

          if (children.length === 0) {
            html += '<div style="padding:16px 12px;text-align:center;opacity:0.5;font-size:11px;">No child processes running</div>';
          } else {
            html += '<div style="max-height:320px;overflow-y:auto;">';
            for (var i = 0; i < children.length; i++) {
              var p = children[i];
              var indent = (p.depth || 0) * 12;
              var isNode = (p.name || '').toLowerCase().indexOf('node') !== -1;
              var nameBg = isNode
                ? (dark ? 'background:#1e3a5f;color:#93c5fd;' : 'background:#eff6ff;color:#1d4ed8;')
                : (dark ? 'background:#334155;color:#e2e8f0;' : 'background:#f1f5f9;color:#475569;');

              html += '<div style="padding:5px 10px 5px ' + (10 + indent) + 'px;display:flex;align-items:center;gap:8px;border-bottom:1px solid ' + (dark ? '#1e293b' : '#f8fafc') + ';">';
              // Process info
              html += '<div style="flex:1;min-width:0;">';
              html += '<div style="display:flex;align-items:center;gap:6px;">';
              html += '<span style="font-weight:500;font-size:11px;padding:1px 5px;border-radius:3px;' + nameBg + '">' + escapeHtml(p.name || '?') + '</span>';
              html += '<span style="font-size:10px;opacity:0.4;font-family:ui-monospace,monospace;">' + p.pid + '</span>';
              html += '</div>';
              var cmd = shortenCmd(p.cmd);
              if (cmd) {
                html += '<div style="font-size:10px;opacity:0.5;margin-top:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-family:ui-monospace,monospace;">' + escapeHtml(cmd) + '</div>';
              }
              html += '</div>';
              // Kill button
              html += '<button onclick="window.__procManager.kill(' + p.pid + ')" style="flex-shrink:0;padding:2px 8px;border-radius:4px;border:none;cursor:pointer;font-size:10px;font-weight:600;transition:all 0.15s;' +
                (dark ? 'background:#7f1d1d;color:#fca5a5;' : 'background:#fef2f2;color:#dc2626;') + '" onmouseenter="this.style.opacity=\'0.8\'" onmouseleave="this.style.opacity=\'1\'">\u2715 Kill</button>';
              html += '</div>';
            }
            html += '</div>';
          }

          // Kill all button
          if (children.length > 1) {
            html += '<div style="padding:6px 10px;border-top:1px solid ' + (dark ? '#334155' : '#e2e8f0') + ';text-align:right;">';
            html += '<button onclick="window.__procManager.killAll()" style="padding:3px 10px;border-radius:5px;border:none;cursor:pointer;font-size:10px;font-weight:600;' +
              (dark ? 'background:#7f1d1d;color:#fca5a5;' : 'background:#fef2f2;color:#dc2626;') + '">Kill All Children</button>';
            html += '</div>';
          }

          panelEl.innerHTML = html;
        }

        function fetchProcesses() {
          fetch('/api/processes')
            .then(function(r) { return r.json(); })
            .then(function(data) {
              lastData = data;
              renderPanel(data);
              // Update toggle button badge
              var children = (data.children || []).filter(function(p) {
                var n = (p.name || '').toLowerCase();
                return n !== 'conhost.exe' && n !== 'powershell.exe' && n !== 'cmd.exe';
              });
              if (toggleBtn) {
                toggleBtn.textContent = children.length > 0 ? '\u2699' + children.length : '\u2699';
              }
            })
            .catch(function() {});
        }

        function startPolling() {
          stopPolling();
          pollTimer = setInterval(fetchProcesses, 3000);
        }
        function stopPolling() {
          if (pollTimer) { clearInterval(pollTimer); pollTimer = null; }
        }

        function killProcess(pid) {
          fetch('/api/processes/' + pid + '/kill', { method: 'POST' })
            .then(function() { setTimeout(fetchProcesses, 500); })
            .catch(function() {});
        }

        function killAll() {
          if (!lastData || !lastData.children) return;
          var children = lastData.children.filter(function(p) {
            var n = (p.name || '').toLowerCase();
            return n !== 'conhost.exe' && n !== 'powershell.exe' && n !== 'cmd.exe';
          });
          // Kill top-level children (tree kill will get the rest)
          var topLevel = children.filter(function(p) { return (p.depth || 0) === 0; });
          for (var i = 0; i < topLevel.length; i++) {
            fetch('/api/processes/' + topLevel[i].pid + '/kill', { method: 'POST' }).catch(function() {});
          }
          setTimeout(fetchProcesses, 1000);
        }

        // Init
        window.addEventListener('load', function() {
          createToggleButton();
          createPanel();
          // Do an initial fetch to set badge count
          fetchProcesses();
          // Light background poll for badge count even when collapsed
          setInterval(fetchProcesses, 10000);
        });

        window.__procManager = {
          kill: killProcess,
          killAll: killAll
        };
      })();
    </script>

    <!-- AskUserQuestion handler -->
    <script>
      (function() {
        // Track the current requestId from outgoing chat requests
        var currentRequestId = null;

        // Monkey-patch fetch to intercept /api/chat streams
        var originalFetch = window.fetch;
        window.fetch = function() {
          var args = arguments;
          var url = (args[0] && typeof args[0] === 'string') ? args[0] : (args[0] && args[0].url ? args[0].url : '');
          var opts = args[1] || {};

          // Capture requestId from outgoing chat requests
          if (url.indexOf('/api/chat') !== -1 && opts.method && opts.method.toUpperCase() === 'POST' && opts.body) {
            try {
              var bodyObj = JSON.parse(opts.body);
              if (bodyObj.requestId) {
                currentRequestId = bodyObj.requestId;
                console.log('[AskUser] Tracking requestId:', currentRequestId);
              }
            } catch(e) {}
          }

          return originalFetch.apply(this, args).then(function(response) {
            // Only intercept /api/chat streaming responses
            if (url.indexOf('/api/chat') === -1 || !response.body) return response;

            var reader = response.body.getReader();
            var decoder = new TextDecoder();
            var buffer = '';

            var newStream = new ReadableStream({
              start: function(controller) {
                function pump() {
                  reader.read().then(function(result) {
                    if (result.done) {
                      if (window.__messageQueue) window.__messageQueue.onStreamDone();
                      controller.close();
                      return;
                    }
                    var text = decoder.decode(result.value, { stream: true });
                    buffer += text;

                    // Process complete NDJSON lines
                    var lines = buffer.split('\n');
                    buffer = lines.pop() || ''; // keep incomplete line in buffer

                    for (var i = 0; i < lines.length; i++) {
                      var line = lines[i].trim();
                      if (!line) continue;
                      try {
                        var msg = JSON.parse(line);
                        // Filter out heartbeat messages (keep connection alive, not for React)
                        if (msg.type === 'heartbeat') {
                          if (window.__thinkingProgress) window.__thinkingProgress.onHeartbeat();
                          continue;
                        }
                        if (msg.type === 'ask_user_question') {
                          console.log('[AskUser] Question received:', msg);
                          showQuestionModal(msg);
                          // Don't forward this custom message to React
                          continue;
                        }
                      } catch(e) {}
                      // Extract data from SDK messages
                      if (msg && msg.type === 'claude_json' && msg.data) {
                        try {
                          var sd = msg.data;
                          var tp = window.__thinkingProgress;

                          // Capture full session_id from SDK messages
                          if (sd.session_id && sd.session_id !== window.__currentFullSessionId) {
                            window.__currentFullSessionId = sd.session_id;
                            console.log('[Session] Full session ID:', sd.session_id);
                            // Update tab title with new session ID (important for forks)
                            var shortSid = sd.session_id.substring(0, 8);
                            try {
                              var _titles = JSON.parse(localStorage.getItem('claude-webui-session-titles') || '{}');
                              var _name = _titles[sd.session_id] || _titles[shortSid] || '';
                              document.title = (_name ? _name + ' ' : '') + '[' + shortSid + '] Claude Code';
                            } catch(e3) {
                              document.title = '[' + shortSid + '] Claude Code';
                            }
                          }

                          // Extract token/usage data from result messages
                          if (tp && sd.type === 'result' && sd.usage) {
                            tp.onTokens(sd.usage.input_tokens, sd.usage.output_tokens);
                          }

                          // Process assistant message content blocks
                          if (sd.type === 'assistant' && sd.message && sd.message.content) {
                            // Extract usage from message-level usage field
                            if (tp && sd.message.usage) {
                              tp.onTokens(sd.message.usage.input_tokens, sd.message.usage.output_tokens);
                            }
                            for (var ti = 0; ti < sd.message.content.length; ti++) {
                              var block = sd.message.content[ti];

                              // Count tokens from text content (~4 chars per token)
                              if (tp && block.type === 'text' && block.text) {
                                tp.addStreamTokens(Math.ceil(block.text.length / 4));
                              }

                              // Count tokens from thinking content
                              if (tp && block.type === 'thinking' && block.thinking) {
                                tp.addThinkingTokens(Math.ceil(block.thinking.length / 4));
                              }

                              // Track todo updates
                              if (window.__todoPanel && block.type === 'tool_use' && block.name === 'TodoWrite' && block.input && block.input.todos) {
                                window.__todoPanel.update(block.input.todos);
                              }

                              // Track active tool for thinking indicator
                              if (tp && block.type === 'tool_use' && block.name) {
                                var toolLabel = block.name;
                                if (block.input) {
                                  if (block.input.command) toolLabel += ': ' + block.input.command.substring(0, 40);
                                  else if (block.input.file_path) toolLabel += ': ' + block.input.file_path.split(/[/\\]/).pop();
                                  else if (block.input.pattern) toolLabel += ': ' + block.input.pattern;
                                }
                                tp.onToolUse(toolLabel);
                              }
                            }
                          }
                        } catch(te) {}
                      }
                      // Forward all other lines to React
                      if (window.__thinkingProgress) window.__thinkingProgress.onChunk(line.length);
                      controller.enqueue(new TextEncoder().encode(line + '\n'));
                    }
                    pump();
                  }).catch(function(err) {
                    controller.error(err);
                  });
                }
                pump();
              }
            });

            return new Response(newStream, {
              headers: response.headers,
              status: response.status,
              statusText: response.statusText
            });
          });
        };

        // Show question modal
        function showQuestionModal(msg) {
          // Remove existing modal if any
          var existing = document.getElementById('ask-user-modal');
          if (existing) existing.remove();

          var questions = msg.questions || [];
          if (questions.length === 0) return;

          var overlay = document.createElement('div');
          overlay.id = 'ask-user-modal';
          overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);z-index:10000;display:flex;align-items:center;justify-content:center;';

          var modal = document.createElement('div');
          modal.style.cssText = 'background:#1e1e2e;border:1px solid #444;border-radius:12px;padding:24px;max-width:560px;width:90%;max-height:80vh;overflow-y:auto;color:#e0e0e0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;box-shadow:0 8px 32px rgba(0,0,0,0.5);';

          var title = document.createElement('div');
          title.style.cssText = 'font-size:14px;font-weight:600;color:#a0a0b0;margin-bottom:16px;text-transform:uppercase;letter-spacing:0.5px;';
          title.textContent = 'Claude has a question';
          modal.appendChild(title);

          var selections = {}; // questionText -> selected answer(s)

          questions.forEach(function(q, qIdx) {
            var qBlock = document.createElement('div');
            qBlock.style.cssText = 'margin-bottom:20px;';

            if (q.header) {
              var header = document.createElement('div');
              header.style.cssText = 'display:inline-block;background:#3a3a5a;color:#c0c0e0;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:600;margin-bottom:8px;';
              header.textContent = q.header;
              qBlock.appendChild(header);
            }

            var qText = document.createElement('div');
            qText.style.cssText = 'font-size:15px;font-weight:500;margin-bottom:12px;line-height:1.4;';
            qText.textContent = q.question;
            qBlock.appendChild(qText);

            var opts = q.options || [];
            var isMulti = q.multiSelect === true;
            selections[q.question] = isMulti ? [] : '';

            opts.forEach(function(opt, oIdx) {
              var optEl = document.createElement('label');
              optEl.style.cssText = 'display:flex;align-items:flex-start;gap:10px;padding:10px 12px;margin-bottom:6px;background:#2a2a3e;border:1px solid #3a3a5a;border-radius:8px;cursor:pointer;transition:border-color 0.15s;';
              optEl.onmouseover = function() { this.style.borderColor = '#6a6aaa'; };
              optEl.onmouseout = function() { if (!this.querySelector('input').checked) this.style.borderColor = '#3a3a5a'; else this.style.borderColor = '#7a7afa'; };

              var input = document.createElement('input');
              input.type = isMulti ? 'checkbox' : 'radio';
              input.name = 'ask_q_' + qIdx;
              input.value = opt.label;
              input.style.cssText = 'margin-top:3px;accent-color:#7a7afa;';
              input.onchange = function() {
                if (isMulti) {
                  var arr = [];
                  qBlock.querySelectorAll('input:checked').forEach(function(cb) { arr.push(cb.value); });
                  selections[q.question] = arr.join(', ');
                } else {
                  selections[q.question] = this.value;
                  // Update border styling for radio buttons
                  qBlock.querySelectorAll('label').forEach(function(l) { l.style.borderColor = '#3a3a5a'; });
                  this.closest('label').style.borderColor = '#7a7afa';
                }
              };

              var textWrap = document.createElement('div');
              var labelText = document.createElement('div');
              labelText.style.cssText = 'font-size:14px;font-weight:500;';
              labelText.textContent = opt.label;
              textWrap.appendChild(labelText);

              if (opt.description) {
                var desc = document.createElement('div');
                desc.style.cssText = 'font-size:12px;color:#888;margin-top:2px;';
                desc.textContent = opt.description;
                textWrap.appendChild(desc);
              }

              optEl.appendChild(input);
              optEl.appendChild(textWrap);
              qBlock.appendChild(optEl);
            });

            // "Other" free-text option
            var otherEl = document.createElement('label');
            otherEl.style.cssText = 'display:flex;align-items:flex-start;gap:10px;padding:10px 12px;margin-bottom:6px;background:#2a2a3e;border:1px solid #3a3a5a;border-radius:8px;cursor:pointer;transition:border-color 0.15s;';

            var otherInput = document.createElement('input');
            otherInput.type = isMulti ? 'checkbox' : 'radio';
            otherInput.name = 'ask_q_' + qIdx;
            otherInput.value = '__other__';
            otherInput.style.cssText = 'margin-top:3px;accent-color:#7a7afa;';

            var otherWrap = document.createElement('div');
            otherWrap.style.cssText = 'flex:1;';
            var otherLabel = document.createElement('div');
            otherLabel.style.cssText = 'font-size:14px;font-weight:500;';
            otherLabel.textContent = 'Other';
            otherWrap.appendChild(otherLabel);

            var otherTextInput = document.createElement('input');
            otherTextInput.type = 'text';
            otherTextInput.placeholder = 'Type your answer...';
            otherTextInput.style.cssText = 'width:100%;margin-top:6px;padding:6px 8px;background:#1e1e2e;border:1px solid #3a3a5a;border-radius:4px;color:#e0e0e0;font-size:13px;display:none;';
            otherWrap.appendChild(otherTextInput);

            otherInput.onchange = function() {
              if (this.checked) {
                otherTextInput.style.display = 'block';
                otherTextInput.focus();
                if (!isMulti) {
                  qBlock.querySelectorAll('label').forEach(function(l) { l.style.borderColor = '#3a3a5a'; });
                }
                this.closest('label').style.borderColor = '#7a7afa';
              } else {
                otherTextInput.style.display = 'none';
              }
            };
            otherTextInput.oninput = function() {
              selections[q.question] = this.value;
            };

            otherEl.appendChild(otherInput);
            otherEl.appendChild(otherWrap);
            qBlock.appendChild(otherEl);

            modal.appendChild(qBlock);
          });

          // Submit button
          var btnWrap = document.createElement('div');
          btnWrap.style.cssText = 'display:flex;justify-content:flex-end;gap:8px;margin-top:8px;';

          var submitBtn = document.createElement('button');
          submitBtn.textContent = 'Submit';
          submitBtn.style.cssText = 'padding:8px 24px;background:#7a7afa;color:#fff;border:none;border-radius:6px;font-size:14px;font-weight:500;cursor:pointer;transition:background 0.15s;';
          submitBtn.onmouseover = function() { this.style.background = '#6a6aea'; };
          submitBtn.onmouseout = function() { this.style.background = '#7a7afa'; };
          submitBtn.onclick = function() {
            // Build answers object
            var answers = {};
            questions.forEach(function(q) {
              answers[q.question] = selections[q.question] || '';
            });
            console.log('[AskUser] Submitting answers:', answers);

            // POST to backend
            originalFetch('/api/answer/' + encodeURIComponent(msg.requestId), {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                questionId: msg.questionId,
                answers: answers
              })
            }).then(function(resp) {
              console.log('[AskUser] Answer submitted, status:', resp.status);
            }).catch(function(err) {
              console.error('[AskUser] Failed to submit answer:', err);
            });

            overlay.remove();
          };

          btnWrap.appendChild(submitBtn);
          modal.appendChild(btnWrap);
          overlay.appendChild(modal);
          document.body.appendChild(overlay);
        }
      })();
    </script>
  </body>
</html>
